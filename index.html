<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monthly Tracker</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3B82F6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Monthly Tracker">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9IiMzQjgyRjYiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSIjZmZmZmZmIj4KICA8cGF0aCBkPSJNMTIgMkM2LjQ4IDIgMiA2LjQ4IDIgMTJzNC40OCAxMCAxMCAxMCAxMC00LjQ4IDEwLTEwUzE3LjUyIDIgMTIgMnptLTIgMTVsLTUtNSAxLjQxLTEuNDFMMTAgMTQuMTdsNy41OS03LjU5TDE5IDhsLTkgOXoiLz4KPC9zdmc+Cg==">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIk1vbnRobHkgVHJhY2tlciIsCiAgInNob3J0X25hbWUiOiAiVHJhY2tlciIsCiAgImRlc2NyaXB0aW9uIjogIlRyYWNrIHlvdXIgaW5jb21lIGFuZCBleHBlbnNlcyBlZmZvcnRsZXNzbHkiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiMzQjgyRjYiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0YVdSMGFEMGlNVGt5SWlCb1pXbG5hSFE5SWpFNU1pSWdkbWxsZDBKdmVEMGlNQ0F3SUFFNU1pQXhPVElpSUdacGJHdzlJbTV2Ym1VaUlIaHRiRzV6UFNKb2RIUndPaTh2ZDNkM0xuY3pMbTl5Wnk4eU1EQXdMM04yWnlJK0NqeHlaV04wSUhkcFpIUm9QU0l4T1RJaUlHaGxhV2RvZEQwaU1Ua3lJaUJ5ZUQwaU1qUWlJR1pwYkd3OUlpTXpRamczUmpZaUx6NEtQSE4yWnlCNFBTSTBPQ0lnZVQwaU5EZ2lJSGRwWkhSb1BTSTVOaUlnYUdWcFoyaDBQU0k1TmlJZ2RtbGxkMEp2ZUQwaU1DQXdJREkwSURJMElpQm1hV3hzUFNJalpsbVptWm1abUlqNEtJQ0E4Y0dGMGFDQmtQU0pOTVRJZ01rTTJMalE0SURJZ01pQTJMalE0SURJZ01USWdNeUE0TGpRNElERXdJREV3SURRdU5EZ2dNVEFnTVRBZ01UQmtMamc0SURFd0lERXdMVFF1TkRnZ01UQXRNVEJUTVRjdU5USWdNaUF4TWlBeWVtMHRNaUF4TldrdE5TMDFJREV1TkRFdE1TNDBNVXd4TUNBeE5DNHhObmczTGpVNUxUY3VOVTU4TVRrZ09HeHRPU0E1ZWlJdlBnbzhMM04yWno0SyI9IiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        .icon { width: 20px; height: 20px; display: inline-block; }
        .icon-lg { width: 32px; height: 32px; }
        .icon-sm { width: 16px; height: 16px; }
        
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #3B82F6, #8B5CF6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .app-loaded .loading-screen {
            display: none;
        }

        .month-tab {
            transition: all 0.3s ease;
            min-height: 80px;
        }

        .month-tab:hover {
            transform: translateY(-2px);
        }

        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }

        /* Mobile-specific enhancements */
        @media (max-width: 768px) {
            .chart-container {
                height: 200px;
            }
            
            .mobile-sticky-header {
                position: -webkit-sticky;
                position: sticky;
                top: 0;
                z-index: 40;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            }
            
            .mobile-scroll {
                max-height: 60vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .mobile-fab {
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 50;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            }
            
            .mobile-sheet {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-radius: 20px 20px 0 0;
                z-index: 60;
                transform: translateY(100%);
                transition: transform 0.3s ease;
                max-height: 85vh;
                overflow-y: auto;
            }
            
            .mobile-sheet.open {
                transform: translateY(0);
            }
            
            .mobile-backdrop {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 55;
                opacity: 0;
                transition: opacity 0.3s ease;
                pointer-events: none;
            }
            
            .mobile-backdrop.open {
                opacity: 1;
                pointer-events: all;
            }
            
            .touch-target {
                min-height: 44px;
                min-width: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .month-tab {
                min-height: 70px;
            }
        }

        /* Custom scrollbar for mobile */
        .mobile-scroll::-webkit-scrollbar {
            width: 4px;
        }
        
        .mobile-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 2px;
        }
        
        .mobile-scroll::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 2px;
        }
        
        .mobile-scroll::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* Swipe indicator */
        .swipe-indicator {
            width: 40px;
            height: 4px;
            background: #ccc;
            border-radius: 2px;
            margin: 0 auto;
        }

        /* Better touch feedback */
        .touch-feedback:active {
            transform: scale(0.95);
            transition: transform 0.1s ease;
        }

        /* Improved input focus for mobile */
        input:focus, select:focus, textarea:focus {
            transform: none !important;
            zoom: 1;
        }

        /* Prevent zoom on input focus on iOS */
        @media screen and (-webkit-min-device-pixel-ratio: 0) {
            select, textarea, input[type="text"], input[type="password"], 
            input[type="datetime"], input[type="datetime-local"], 
            input[type="date"], input[type="month"], input[type="time"], 
            input[type="week"], input[type="number"], input[type="email"], 
            input[type="url"] {
                font-size: 16px;
            }
        }
        
        /* Carry forward balance styling */
        .carry-forward-badge {
            background: linear-gradient(45deg, #10B981, #059669);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }
        
        .opening-balance-card {
            background: linear-gradient(135deg, #10B981, #059669);
            border: none;
            color: white;
        }
        
        .opening-balance-card .text-green-600 {
            color: white !important;
        }

        /* Balance breakdown styling */
        .balance-breakdown {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 1px solid #0284c7;
            border-radius: 12px;
            padding: 12px;
            margin-top: 8px;
        }

        .balance-component {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: 12px;
        }

        .balance-component.opening {
            color: #059669;
            font-weight: 600;
        }

        .balance-component.current {
            color: #1f2937;
            font-weight: 500;
        }

        .balance-component.total {
            border-top: 1px solid #0284c7;
            padding-top: 8px;
            margin-top: 4px;
            font-weight: 700;
            color: #0c4a6e;
        }

        /* Credit card styling */
        .credit-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .credit-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }

        .credit-card-chip {
            width: 32px;
            height: 24px;
            background: linear-gradient(135deg, #ffd700, #ffed4a);
            border-radius: 4px;
            position: relative;
        }

        .credit-card-number {
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }

        .cc-debt-badge {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }

        .navigation-tabs {
            background: white;
            border-radius: 16px;
            padding: 4px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .nav-tab {
            flex: 1;
            padding: 12px 16px;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #3B82F6, #8B5CF6);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .nav-tab:not(.active) {
            color: #6b7280;
        }

        .nav-tab:not(.active):hover {
            background: #f3f4f6;
            color: #374151;
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="text-center">
            <div class="loading-spinner text-6xl mb-4">💰</div>
            <h1 class="text-2xl font-bold">Monthly Tracker</h1>
            <p class="text-blue-200">Loading your financial dashboard...</p>
        </div>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Enhanced CloudSync with Credit Card support
        window.CloudSync = window.CloudSync || {
            data: {},
            users: {
                'admin': { password: 'admin123', name: 'Administrator', isAdmin: true },
                'arpbat': { password: 'arpitha7', name: 'Arpitha Battu' },
                'sarvesh': { password: 'sarvesh123', name: 'Sarvesh Kommawar' },
                'vanshika': { password: 'vanshika123', name: 'Vanshika Battu' }
            },
            
            // Save user data to cloud (organized by year and month)
            saveUserData: function(username, year, month, transactions) {
                if (!this.data[username]) this.data[username] = {};
                if (!this.data[username][year]) this.data[username][year] = {};
                this.data[username][year][month] = transactions;
                
                // Also save to localStorage as backup
                localStorage.setItem(`monthlyTracker_${username}_${year}_${month}`, JSON.stringify(transactions));
            },
            
            // Save credit cards data
            saveCreditCards: function(username, year, month, creditCards) {
                if (!this.data[username]) this.data[username] = {};
                if (!this.data[username][year]) this.data[username][year] = {};
                if (!this.data[username][year][month]) this.data[username][year][month] = [];
                
                // Store credit cards separately
                const key = `creditCards_${username}_${year}_${month}`;
                localStorage.setItem(key, JSON.stringify(creditCards));
            },

            // Get credit cards data
            getCreditCards: function(username, year, month) {
                try {
                    const key = `creditCards_${username}_${year}_${month}`;
                    const saved = localStorage.getItem(key);
                    return saved ? JSON.parse(saved) : [];
                } catch (error) {
                    return [];
                }
            },
            
            // Get user data from cloud (for specific year and month)
            getUserData: function(username, year, month) {
                // Try cloud first
                if (this.data[username] && this.data[username][year] && this.data[username][year][month]) {
                    return this.data[username][year][month];
                }
                
                // Then localStorage as fallback
                try {
                    const saved = localStorage.getItem(`monthlyTracker_${username}_${year}_${month}`);
                    const data = saved ? JSON.parse(saved) : [];
                    
                    // Sync to cloud
                    if (!this.data[username]) this.data[username] = {};
                    if (!this.data[username][year]) this.data[username][year] = {};
                    this.data[username][year][month] = data;
                    
                    return data;
                } catch (error) {
                    return [];
                }
            },

            // Get all data for a user (all years and months)
            getAllUserData: function(username) {
                const allData = {};
                
                // Load from cloud and localStorage for years 2025-2030
                for (let year = 2025; year <= 2030; year++) {
                    allData[year] = {};
                    for (let month = 0; month < 12; month++) {
                        const monthName = ['January', 'February', 'March', 'April', 'May', 'June',
                                         'July', 'August', 'September', 'October', 'November', 'December'][month];
                        allData[year][monthName] = this.getUserData(username, year, monthName);
                    }
                }
                
                return allData;
            },
            
            // Add new user
            addUser: function(username, password, name, isAdmin = false) {
                this.users[username] = { password, name, isAdmin };
                localStorage.setItem('userDatabase', JSON.stringify(this.users));
                return true;
            },

            // Change password
            changePassword: function(username, oldPassword, newPassword) {
                if (!this.users[username]) {
                    return { success: false, error: 'User not found' };
                }
                
                if (this.users[username].password !== oldPassword) {
                    return { success: false, error: 'Current password is incorrect' };
                }
                
                if (newPassword.length < 6) {
                    return { success: false, error: 'New password must be at least 6 characters' };
                }
                
                this.users[username].password = newPassword;
                localStorage.setItem('userDatabase', JSON.stringify(this.users));
                return { success: true };
            },
            
            // Load users from localStorage on app start
            loadUsers: function() {
                try {
                    const saved = localStorage.getItem('userDatabase');
                    if (saved) {
                        this.users = { ...this.users, ...JSON.parse(saved) };
                    }
                } catch (error) {
                    console.log('Error loading users from localStorage');
                }
            },

            // Get previous month balance
            getPreviousMonthBalance: function(username, year, month) {
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                 'July', 'August', 'September', 'October', 'November', 'December'];
                const currentMonthIndex = monthNames.indexOf(month);
                
                let prevYear = year;
                let prevMonthIndex = currentMonthIndex - 1;
                
                if (prevMonthIndex < 0) {
                    prevMonthIndex = 11;
                    prevYear = year - 1;
                    if (prevYear < 2025) return 0; // No previous month before 2025
                }
                
                const prevMonth = monthNames[prevMonthIndex];
                const prevTransactions = this.getUserData(username, prevYear, prevMonth);
                
                const income = prevTransactions
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);
                const expenses = prevTransactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                return income - expenses;
            },

            // Check if opening balance exists for a month
            hasOpeningBalance: function(username, year, month) {
                const transactions = this.getUserData(username, year, month);
                return transactions.some(t => t.isOpeningBalance);
            },

            // Add opening balance transaction
            addOpeningBalance: function(username, year, month, amount) {
                if (amount === 0) return; // Don't add if balance is zero
                
                const transactions = this.getUserData(username, year, month);
                
                // Remove existing opening balance if any
                const filteredTransactions = transactions.filter(t => !t.isOpeningBalance);
                
                // Add new opening balance
                const openingBalanceTransaction = {
                    id: `opening_${year}_${month}_${Date.now()}`,
                    type: amount >= 0 ? 'income' : 'expense',
                    category: 'Opening Balance',
                    amount: Math.abs(amount),
                    description: `Balance carried forward from previous month`,
                    date: new Date(year, ['January', 'February', 'March', 'April', 'May', 'June',
                                         'July', 'August', 'September', 'October', 'November', 'December'].indexOf(month), 1)
                                         .toISOString().split('T')[0],
                    isOpeningBalance: true,
                    timestamp: Date.now()
                };
                
                // Add at the beginning of transactions
                const updatedTransactions = [openingBalanceTransaction, ...filteredTransactions];
                this.saveUserData(username, year, month, updatedTransactions);
                
                return updatedTransactions;
            }
        };

        // Initialize cloud sync
        window.CloudSync.loadUsers();
        
        // Icon components
        const PlusCircle = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="16"></line>
                <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
        );

        const Plus = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const TrendingUp = () => (
            <svg className="icon-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                <polyline points="17 6 23 6 23 12"></polyline>
            </svg>
        );

        const TrendingDown = () => (
            <svg className="icon-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
                <polyline points="17 18 23 18 23 12"></polyline>
            </svg>
        );

        const RupeeSign = () => (
            <svg className="icon-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M6 3h12M6 8h12m-12 5a3 3 0 1 0 0-6m0 6a3 3 0 1 1 0 6M18 13l-8 8"/>
            </svg>
        );

        const CreditCard = () => (
            <svg className="icon-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                <line x1="1" y1="10" x2="23" y2="10"></line>
            </svg>
        );

        const Eye = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
            </svg>
        );

        const EyeOff = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                <line x1="1" y1="1" x2="23" y2="23"></line>
            </svg>
        );

        const Trash2 = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="3,6 5,6 21,6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        const Edit = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
        );

        const User = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
        );

        const LogOut = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16,17 21,12 16,7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
        );

        const UserPlus = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <line x1="20" y1="8" x2="20" y2="14"></line>
                <line x1="23" y1="11" x2="17" y2="11"></line>
            </svg>
        );

        const Lock = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <circle cx="12" cy="16" r="1"></circle>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
        );

        const Calendar = () => (
            <svg className="icon-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        );

        const ChevronLeft = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="15,18 9,12 15,6"></polyline>
            </svg>
        );

        const ChevronRight = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="9,18 15,12 9,6"></polyline>
            </svg>
        );

        const X = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        );

        const Menu = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        );

        const BarChart3 = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M3 3v18h18"></path>
                <path d="M18 17V9"></path>
                <path d="M13 17V5"></path>
                <path d="M8 17v-3"></path>
            </svg>
        );

        const Save = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17,21 17,13 7,13 7,21"></polyline>
                <polyline points="7,3 7,8 15,8"></polyline>
            </svg>
        );

        const ArrowRight = () => (
            <svg className="icon-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <line x1="5" y1="12" x2="19" y2="12"></line>
                <polyline points="12,5 19,12 12,19"></polyline>
            </svg>
        );

        // Pie Chart Component
        const PieChart = ({ data, title, type }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                if (data.length === 0) return;

                const ctx = chartRef.current.getContext('2d');
                
                const colors = type === 'income' ? [
                    '#10B981', '#059669', '#047857', '#065F46', '#064E3B', '#16A34A', '#15803D', '#166534'
                ] : [
                    '#EF4444', '#DC2626', '#B91C1C', '#991B1B', '#7F1D1D', '#F97316', '#EA580C', '#C2410C'
                ];

                chartInstance.current = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: data.map(item => item.category),
                        datasets: [{
                            data: data.map(item => item.total),
                            backgroundColor: colors.slice(0, data.length),
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    usePointStyle: true,
                                    font: {
                                        size: window.innerWidth < 768 ? 10 : 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return `${context.label}: ₹${context.parsed.toLocaleString('en-IN')} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [data, type]);

            if (data.length === 0) {
                return (
                    <div className="chart-container flex items-center justify-center">
                        <div className="text-center text-gray-500">
                            <div className="text-4xl mb-2">📊</div>
                            <p className="text-sm">No {type} data for this month</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="chart-container">
                    <canvas ref={chartRef}></canvas>
                </div>
            );
        };

        // Mobile-Optimized Login Component
        const LoginForm = ({ onLogin }) => {
            const [loginData, setLoginData] = useState({ username: '', password: '' });
            const [error, setError] = useState('');

            const handleLogin = () => {
                const { username, password } = loginData;
                
                if (!username || !password) {
                    setError('Please enter both username and password');
                    return;
                }

                if (window.CloudSync.users[username] && window.CloudSync.users[username].password === password) {
                    onLogin(username, window.CloudSync.users[username].name, window.CloudSync.users[username].isAdmin || false);
                    setError('');
                } else {
                    setError('Invalid username or password');
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="text-6xl mb-4">💰</div>
                            <h1 className="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">Monthly Tracker</h1>
                            <p className="text-gray-600 text-sm sm:text-base">Sign in to access your financial data</p>
                        </div>

                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                <input
                                    type="text"
                                    value={loginData.username}
                                    onChange={(e) => setLoginData({...loginData, username: e.target.value})}
                                    onKeyPress={handleKeyPress}
                                    className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Enter username"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input
                                    type="password"
                                    value={loginData.password}
                                    onChange={(e) => setLoginData({...loginData, password: e.target.value})}
                                    onKeyPress={handleKeyPress}
                                    className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Enter password"
                                />
                            </div>

                            {error && (
                                <div className="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm">
                                    {error}
                                </div>
                            )}

                            <button
                                onClick={handleLogin}
                                className="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-4 px-4 rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all duration-200 font-semibold text-base touch-feedback"
                            >
                                Sign In
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Credit Card Management Component
        const CreditCardManager = ({ currentUser, selectedYear, selectedMonth }) => {
            const [creditCards, setCreditCards] = useState(() => 
                window.CloudSync.getCreditCards(currentUser, selectedYear, selectedMonth)
            );
            const [showAddCard, setShowAddCard] = useState(false);
            const [showAddExpense, setShowAddExpense] = useState(false);
            const [selectedCard, setSelectedCard] = useState(null);
            const [cardForm, setCardForm] = useState({
                name: '',
                lastFour: '',
                limit: '',
                color: '#667eea'
            });
            const [expenseForm, setExpenseForm] = useState({
                category: '',
                amount: '',
                description: '',
                date: new Date().toISOString().split('T')[0]
            });

            const cardColors = [
                '#667eea', '#764ba2', '#f093fb', '#f5576c', 
                '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
            ];

            const expenseCategories = [
                'Food & Dining', 'Shopping', 'Transportation', 'Entertainment',
                'Healthcare', 'Travel', 'Subscriptions', 'Utilities',
                'Personal Care', 'Education', 'Other Expenses'
            ];

            const categoryIcons = {
                'Food & Dining': '🍽️', 'Shopping': '🛍️', 'Transportation': '🚗', 
                'Entertainment': '🎬', 'Healthcare': '🏥', 'Travel': '✈️',
                'Subscriptions': '📱', 'Utilities': '⚡', 'Personal Care': '💅',
                'Education': '📚', 'Other Expenses': '📦'
            };

            // Save credit cards when they change
            useEffect(() => {
                window.CloudSync.saveCreditCards(currentUser, selectedYear, selectedMonth, creditCards);
            }, [creditCards, currentUser, selectedYear, selectedMonth]);

            // Load credit cards when month/year changes
            useEffect(() => {
                const cards = window.CloudSync.getCreditCards(currentUser, selectedYear, selectedMonth);
                setCreditCards(cards);
            }, [currentUser, selectedYear, selectedMonth]);

            const handleAddCard = () => {
                if (!cardForm.name || !cardForm.lastFour) return;

                const newCard = {
                    id: Date.now(),
                    ...cardForm,
                    limit: parseFloat(cardForm.limit) || 0,
                    expenses: [],
                    createdAt: new Date().toISOString()
                };

                setCreditCards([...creditCards, newCard]);
                setCardForm({ name: '', lastFour: '', limit: '', color: '#667eea' });
                setShowAddCard(false);
            };

            const handleAddExpense = () => {
                if (!expenseForm.category || !expenseForm.amount || !selectedCard) return;

                const expense = {
                    id: Date.now(),
                    ...expenseForm,
                    amount: parseFloat(expenseForm.amount),
                    timestamp: Date.now()
                };

                const updatedCards = creditCards.map(card => 
                    card.id === selectedCard.id 
                        ? { ...card, expenses: [expense, ...card.expenses] }
                        : card
                );

                setCreditCards(updatedCards);
                setExpenseForm({
                    category: '',
                    amount: '',
                    description: '',
                    date: new Date().toISOString().split('T')[0]
                });
                setShowAddExpense(false);
                setSelectedCard(null);
            };

            const deleteExpense = (cardId, expenseId) => {
                const updatedCards = creditCards.map(card => 
                    card.id === cardId 
                        ? { ...card, expenses: card.expenses.filter(e => e.id !== expenseId) }
                        : card
                );
                setCreditCards(updatedCards);
            };

            const deleteCard = (cardId) => {
                setCreditCards(creditCards.filter(card => card.id !== cardId));
            };

            const getCardTotal = (card) => {
                return card.expenses.reduce((sum, expense) => sum + expense.amount, 0);
            };

            const getTotalCreditExpenses = () => {
                return creditCards.reduce((sum, card) => sum + getCardTotal(card), 0);
            };

            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: 'INR'
                }).format(amount);
            };

            const maskCardNumber = (lastFour) => {
                return `**** **** **** ${lastFour}`;
            };

            return (
                <div className="space-y-6">
                    {/* Credit Cards Summary */}
                    <div className="bg-white rounded-xl shadow-lg p-4">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-semibold text-gray-800 flex items-center gap-2">
                                <CreditCard />
                                Credit Cards ({selectedMonth})
                            </h3>
                            <button
                                onClick={() => setShowAddCard(true)}
                                className="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-4 py-2 rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all duration-200 font-semibold text-sm touch-feedback flex items-center gap-2"
                            >
                                <Plus />
                                Add Card
                            </button>
                        </div>

                        {/* Total Credit Expenses */}
                        <div className="bg-gradient-to-r from-red-100 to-pink-100 rounded-lg p-4 mb-4 border-l-4 border-red-500">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-sm text-red-700 font-medium">Total Credit Expenses</p>
                                    <p className="text-2xl font-bold text-red-600">
                                        {formatCurrency(getTotalCreditExpenses())}
                                    </p>
                                    <p className="text-xs text-red-600">
                                        Across {creditCards.length} card{creditCards.length !== 1 ? 's' : ''}
                                    </p>
                                </div>
                                <div className="text-red-500 text-3xl">💳</div>
                            </div>
                        </div>

                        {/* Credit Cards List */}
                        {creditCards.length === 0 ? (
                            <div className="text-center py-12 text-gray-500">
                                <div className="text-4xl mb-2">💳</div>
                                <p className="text-sm">No credit cards added yet.</p>
                                <p className="text-xs mt-2">Add your first credit card to start tracking expenses!</p>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                {creditCards.map(card => {
                                    const total = getCardTotal(card);
                                    const utilization = card.limit > 0 ? (total / card.limit) * 100 : 0;
                                    
                                    return (
                                        <div key={card.id} className="credit-card p-4" style={{ background: `linear-gradient(135deg, ${card.color}, ${card.color}dd)` }}>
                                            <div className="flex justify-between items-start mb-4 relative z-10">
                                                <div>
                                                    <h4 className="text-lg font-bold text-white">{card.name}</h4>
                                                    <p className="text-white opacity-90 credit-card-number text-sm">
                                                        {maskCardNumber(card.lastFour)}
                                                    </p>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <button
                                                        onClick={() => {
                                                            setSelectedCard(card);
                                                            setShowAddExpense(true);
                                                        }}
                                                        className="bg-white bg-opacity-20 text-white p-2 rounded-lg hover:bg-opacity-30 transition-all touch-target"
                                                        title="Add expense"
                                                    >
                                                        <Plus />
                                                    </button>
                                                    <button
                                                        onClick={() => deleteCard(card.id)}
                                                        className="bg-red-500 bg-opacity-20 text-white p-2 rounded-lg hover:bg-opacity-30 transition-all touch-target"
                                                        title="Delete card"
                                                    >
                                                        <Trash2 />
                                                    </button>
                                                </div>
                                            </div>

                                            <div className="flex justify-between items-end mb-4 relative z-10">
                                                <div>
                                                    <p className="text-white opacity-75 text-xs">Current Balance</p>
                                                    <p className="text-2xl font-bold text-white">
                                                        {formatCurrency(total)}
                                                    </p>
                                                    {card.limit > 0 && (
                                                        <p className="text-white opacity-75 text-xs">
                                                            {utilization.toFixed(1)}% of ₹{card.limit.toLocaleString('en-IN')} limit
                                                        </p>
                                                    )}
                                                </div>
                                                <div className="credit-card-chip"></div>
                                            </div>

                                            {/* Usage bar */}
                                            {card.limit > 0 && (
                                                <div className="w-full bg-white bg-opacity-20 rounded-full h-2 mb-4 relative z-10">
                                                    <div 
                                                        className={`h-2 rounded-full transition-all duration-300 ${
                                                            utilization > 80 ? 'bg-red-400' : 
                                                            utilization > 60 ? 'bg-yellow-400' : 'bg-green-400'
                                                        }`}
                                                        style={{ width: `${Math.min(utilization, 100)}%` }}
                                                    ></div>
                                                </div>
                                            )}

                                            {/* Recent Expenses */}
                                            {card.expenses.length > 0 && (
                                                <div className="relative z-10">
                                                    <p className="text-white opacity-75 text-xs mb-2">
                                                        Recent Expenses ({card.expenses.length})
                                                    </p>
                                                    <div className="space-y-1 max-h-32 overflow-y-auto">
                                                        {card.expenses.slice(0, 3).map(expense => (
                                                            <div key={expense.id} className="flex items-center justify-between bg-white bg-opacity-10 rounded-lg p-2">
                                                                <div className="flex items-center gap-2 min-w-0 flex-1">
                                                                    <span className="text-sm">{categoryIcons[expense.category]}</span>
                                                                    <div className="min-w-0 flex-1">
                                                                        <p className="text-white text-xs font-medium truncate">{expense.category}</p>
                                                                        {expense.description && (
                                                                            <p className="text-white opacity-75 text-xs truncate">{expense.description}</p>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                <div className="flex items-center gap-2 ml-2">
                                                                    <span className="text-white text-xs font-bold">₹{expense.amount.toLocaleString('en-IN')}</span>
                                                                    <button
                                                                        onClick={() => deleteExpense(card.id, expense.id)}
                                                                        className="text-red-300 hover:text-red-100 p-1 touch-target"
                                                                        title="Delete expense"
                                                                    >
                                                                        <Trash2 />
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>

                    {/* Add Card Modal */}
                    {showAddCard && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-xl font-bold text-gray-800">Add Credit Card</h3>
                                    <button onClick={() => setShowAddCard(false)} className="p-2 hover:bg-gray-100 rounded-lg touch-target">
                                        <X />
                                    </button>
                                </div>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Card Name *</label>
                                        <input
                                            type="text"
                                            value={cardForm.name}
                                            onChange={(e) => setCardForm({...cardForm, name: e.target.value})}
                                            className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="e.g., HDFC Regalia, SBI Cashback"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Last 4 Digits *</label>
                                        <input
                                            type="text"
                                            maxLength="4"
                                            value={cardForm.lastFour}
                                            onChange={(e) => setCardForm({...cardForm, lastFour: e.target.value.replace(/\D/g, '')})}
                                            className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="1234"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Credit Limit (₹)</label>
                                        <input
                                            type="number"
                                            value={cardForm.limit}
                                            onChange={(e) => setCardForm({...cardForm, limit: e.target.value})}
                                            className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="50000"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Card Color</label>
                                        <div className="flex gap-2 flex-wrap">
                                            {cardColors.map(color => (
                                                <button
                                                    key={color}
                                                    onClick={() => setCardForm({...cardForm, color})}
                                                    className={`w-8 h-8 rounded-full border-2 transition-all touch-feedback ${
                                                        cardForm.color === color ? 'border-gray-800' : 'border-gray-300'
                                                    }`}
                                                    style={{ backgroundColor: color }}
                                                />
                                            ))}
                                        </div>
                                    </div>

                                    <div className="flex gap-3">
                                        <button
                                            onClick={handleAddCard}
                                            disabled={!cardForm.name || !cardForm.lastFour}
                                            className="flex-1 bg-gradient-to-r from-green-500 to-blue-600 text-white py-4 px-4 rounded-lg hover:from-green-600 hover:to-blue-700 transition-all duration-200 font-semibold touch-feedback disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            Add Card
                                        </button>
                                        <button
                                            onClick={() => setShowAddCard(false)}
                                            className="flex-1 bg-gray-500 text-white py-4 px-4 rounded-lg hover:bg-gray-600 transition-all duration-200 font-semibold touch-feedback"
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Add Expense Modal */}
                    {showAddExpense && selectedCard && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-xl font-bold text-gray-800">Add Expense to {selectedCard.name}</h3>
                                    <button onClick={() => { setShowAddExpense(false); setSelectedCard(null); }} className="p-2 hover:bg-gray-100 rounded-lg touch-target">
                                        <X />
                                    </button>
                                </div>
                                
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Category *</label>
                                        <select
                                            value={expenseForm.category}
                                            onChange={(e) => setExpenseForm({...expenseForm, category: e.target.value})}
                                            className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        >
                                            <option value="">Select category</option>
                                            {expenseCategories.map(cat => (
                                                <option key={cat} value={cat}>{categoryIcons[cat]} {cat}</option>
                                            ))}
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Amount (₹) *</label>
                                        <input
                                            type="number"
                                            step="0.01"
                                            value={expenseForm.amount}
                                            onChange={(e) => setExpenseForm({...expenseForm, amount: e.target.value})}
                                            className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="0.00"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                        <input
                                            type="text"
                                            value={expenseForm.description}
                                            onChange={(e) => setExpenseForm({...expenseForm, description: e.target.value})}
                                            className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="Optional description"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">Date</label>
                                        <input
                                            type="date"
                                            value={expenseForm.date}
                                            onChange={(e) => setExpenseForm({...expenseForm, date: e.target.value})}
                                            className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        />
                                    </div>

                                    <div className="flex gap-3">
                                        <button
                                            onClick={handleAddExpense}
                                            disabled={!expenseForm.category || !expenseForm.amount}
                                            className="flex-1 bg-gradient-to-r from-red-500 to-pink-600 text-white py-4 px-4 rounded-lg hover:from-red-600 hover:to-pink-700 transition-all duration-200 font-semibold touch-feedback disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            Add Expense
                                        </button>
                                        <button
                                            onClick={() => { setShowAddExpense(false); setSelectedCard(null); }}
                                            className="flex-1 bg-gray-500 text-white py-4 px-4 rounded-lg hover:bg-gray-600 transition-all duration-200 font-semibold touch-feedback"
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Mobile-Optimized Add User Form Component
        const AddUserForm = ({ onAddUser, onClose }) => {
            const [userData, setUserData] = useState({
                username: '',
                password: '',
                name: '',
                isAdmin: false
            });
            const [error, setError] = useState('');

            const handleSubmit = () => {
                const { username, password, name } = userData;
                
                if (!username || !password || !name) {
                    setError('Please fill all required fields');
                    return;
                }

                if (window.CloudSync.users[username]) {
                    setError('Username already exists');
                    return;
                }

                if (username.length < 3) {
                    setError('Username must be at least 3 characters');
                    return;
                }

                if (password.length < 6) {
                    setError('Password must be at least 6 characters');
                    return;
                }

                window.CloudSync.addUser(username, password, name, userData.isAdmin);
                onAddUser();
                onClose();
                setError('');
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-xl font-bold text-gray-800">Add New User</h3>
                            <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg touch-target">
                                <X />
                            </button>
                        </div>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                                <input
                                    type="text"
                                    value={userData.name}
                                    onChange={(e) => setUserData({...userData, name: e.target.value})}
                                    className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Enter full name"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Username *</label>
                                <input
                                    type="text"
                                    value={userData.username}
                                    onChange={(e) => setUserData({...userData, username: e.target.value.toLowerCase()})}
                                    className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Enter username (min 3 chars)"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Password *</label>
                                <input
                                    type="password"
                                    value={userData.password}
                                    onChange={(e) => setUserData({...userData, password: e.target.value})}
                                    className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Enter password (min 6 chars)"
                                />
                            </div>

                            <div className="flex items-center touch-target">
                                <input
                                    type="checkbox"
                                    id="isAdmin"
                                    checked={userData.isAdmin}
                                    onChange={(e) => setUserData({...userData, isAdmin: e.target.checked})}
                                    className="h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                />
                                <label htmlFor="isAdmin" className="ml-3 block text-sm text-gray-700">
                                    Make this user an admin
                                </label>
                            </div>

                            {error && (
                                <div className="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm">
                                    {error}
                                </div>
                            )}

                            <div className="flex gap-3">
                                <button
                                    onClick={handleSubmit}
                                    className="flex-1 bg-gradient-to-r from-green-500 to-blue-600 text-white py-4 px-4 rounded-lg hover:from-green-600 hover:to-blue-700 transition-all duration-200 font-semibold touch-feedback"
                                >
                                    Add User
                                </button>
                                <button
                                    onClick={onClose}
                                    className="flex-1 bg-gray-500 text-white py-4 px-4 rounded-lg hover:bg-gray-600 transition-all duration-200 font-semibold touch-feedback"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Mobile-Optimized Change Password Form Component
        const ChangePasswordForm = ({ currentUser, onClose, onPasswordChanged }) => {
            const [passwordData, setPasswordData] = useState({
                currentPassword: '',
                newPassword: '',
                confirmPassword: ''
            });
            const [error, setError] = useState('');
            const [success, setSuccess] = useState(false);

            const handleSubmit = () => {
                const { currentPassword, newPassword, confirmPassword } = passwordData;
                
                if (!currentPassword || !newPassword || !confirmPassword) {
                    setError('Please fill all fields');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    setError('New passwords do not match');
                    return;
                }

                if (newPassword.length < 6) {
                    setError('New password must be at least 6 characters');
                    return;
                }

                if (currentPassword === newPassword) {
                    setError('New password must be different from current password');
                    return;
                }

                const result = window.CloudSync.changePassword(currentUser, currentPassword, newPassword);
                
                if (result.success) {
                    setSuccess(true);
                    setError('');
                    setTimeout(() => {
                        onPasswordChanged();
                        onClose();
                    }, 2000);
                } else {
                    setError(result.error);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    handleSubmit();
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
                        <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center gap-2">
                                <Lock />
                                <h3 className="text-xl font-bold text-gray-800">Change Password</h3>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg touch-target">
                                <X />
                            </button>
                        </div>
                        
                        {success ? (
                            <div className="text-center py-8">
                                <div className="text-4xl mb-4">✅</div>
                                <h4 className="text-lg font-semibold text-green-600 mb-2">Password Changed Successfully!</h4>
                                <p className="text-gray-600">You can now use your new password to login.</p>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Current Password *</label>
                                    <input
                                        type="password"
                                        value={passwordData.currentPassword}
                                        onChange={(e) => setPasswordData({...passwordData, currentPassword: e.target.value})}
                                        onKeyPress={handleKeyPress}
                                        className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="Enter current password"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">New Password *</label>
                                    <input
                                        type="password"
                                        value={passwordData.newPassword}
                                        onChange={(e) => setPasswordData({...passwordData, newPassword: e.target.value})}
                                        onKeyPress={handleKeyPress}
                                        className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="Enter new password (min 6 chars)"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Confirm New Password *</label>
                                    <input
                                        type="password"
                                        value={passwordData.confirmPassword}
                                        onChange={(e) => setPasswordData({...passwordData, confirmPassword: e.target.value})}
                                        onKeyPress={handleKeyPress}
                                        className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="Confirm new password"
                                    />
                                </div>

                                {error && (
                                    <div className="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm">
                                        {error}
                                    </div>
                                )}

                                <div className="flex gap-3">
                                    <button
                                        onClick={handleSubmit}
                                        className="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white py-4 px-4 rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all duration-200 font-semibold touch-feedback"
                                    >
                                        Change Password
                                    </button>
                                    <button
                                        onClick={onClose}
                                        className="flex-1 bg-gray-500 text-white py-4 px-4 rounded-lg hover:bg-gray-600 transition-all duration-200 font-semibold touch-feedback"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Mobile Bottom Sheet Component
        const MobileBottomSheet = ({ isOpen, onClose, children, title }) => {
            return (
                <>
                    <div className={`mobile-backdrop ${isOpen ? 'open' : ''}`} onClick={onClose}></div>
                    <div className={`mobile-sheet ${isOpen ? 'open' : ''}`}>
                        <div className="p-4">
                            <div className="swipe-indicator mb-4"></div>
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-semibold text-gray-800">{title}</h3>
                                <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg touch-target">
                                    <X />
                                </button>
                            </div>
                            {children}
                        </div>
                    </div>
                </>
            );
        };

        // Main Mobile-Enhanced Tracker Component
        const MonthlyTracker = ({ currentUser, userName, isAdmin, onLogout }) => {
            const currentDate = new Date();
            const defaultYear = Math.max(2025, Math.min(currentDate.getFullYear(), 2030));
            const currentMonthIndex = currentDate.getMonth();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            const [selectedYear, setSelectedYear] = useState(defaultYear);
            const [selectedMonth, setSelectedMonth] = useState(monthNames[currentMonthIndex]);
            const [activeTab, setActiveTab] = useState('overview'); // 'overview', 'transactions', 'creditcards'
            const [transactions, setTransactions] = useState(() => 
                window.CloudSync.getUserData(currentUser, defaultYear, monthNames[currentMonthIndex])
            );
            const [showMobileForm, setShowMobileForm] = useState(false);
            const [showMobileMenu, setShowMobileMenu] = useState(false);
            const [formData, setFormData] = useState({
                type: 'expense',
                category: '',
                amount: '',
                description: '',
                date: new Date().toISOString().split('T')[0]
            });
            const [showBalance, setShowBalance] = useState(true);
            const [showCredentials, setShowCredentials] = useState(false);
            const [showAddUser, setShowAddUser] = useState(false);
            const [showChangePassword, setShowChangePassword] = useState(false);
            const [userRefresh, setUserRefresh] = useState(0);
            const [editingTransaction, setEditingTransaction] = useState(null);
            const [isEditMode, setIsEditMode] = useState(false);

            // Helper function to get the default date for selected month/year
            const getDefaultDateForMonth = (year, month) => {
                const monthIndex = monthNames.indexOf(month);
                let date;
                
                // If it's the current month and year, use today's date
                if (year === currentDate.getFullYear() && monthIndex === currentDate.getMonth()) {
                    date = currentDate;
                } else {
                    // Otherwise, use the first day of the selected month
                    date = new Date(year, monthIndex, 1);
                }
                
                return date.toISOString().split('T')[0];
            };

            // Load transactions when month/year changes and handle carry forward
            useEffect(() => {
                let monthTransactions = window.CloudSync.getUserData(currentUser, selectedYear, selectedMonth);
                
                // Check if we need to add opening balance
                const hasOpeningBalance = window.CloudSync.hasOpeningBalance(currentUser, selectedYear, selectedMonth);
                const prevMonthBalance = window.CloudSync.getPreviousMonthBalance(currentUser, selectedYear, selectedMonth);
                
                // Add opening balance if it doesn't exist and there's a previous balance
                if (!hasOpeningBalance && prevMonthBalance !== 0) {
                    monthTransactions = window.CloudSync.addOpeningBalance(currentUser, selectedYear, selectedMonth, prevMonthBalance);
                }
                
                setTransactions(monthTransactions);
            }, [currentUser, selectedYear, selectedMonth]);

            // Update form date when month/year changes
            useEffect(() => {
                if (!isEditMode) {
                    setFormData(prev => ({
                        ...prev,
                        date: getDefaultDateForMonth(selectedYear, selectedMonth)
                    }));
                }
            }, [selectedYear, selectedMonth, isEditMode]);

            // Save data whenever transactions change
            useEffect(() => {
                window.CloudSync.saveUserData(currentUser, selectedYear, selectedMonth, transactions);
            }, [transactions, currentUser, selectedYear, selectedMonth]);

            const incomeCategories = [
                'Salary/Wages', 'Freelance', 'Business Income', 'Investment Returns', 
                'Rental Income', 'Side Hustle', 'Gifts/Bonus', 'Opening Balance', 'Other Income'
            ];

            const expenseCategories = [
                'Rent', 'Transportation', 'Food & Dining', 'Utilities', 'Healthcare',
                'Insurance', 'Shopping', 'Entertainment', 'Education', 'Personal Care',
                'Travel', 'Subscriptions', 'Debt Payments', 'Savings', 'Home', 'Opening Balance', 'Other Expenses'
            ];

            const categoryIcons = {
                'Salary/Wages': '💼', 'Freelance': '💻', 'Business Income': '🏢', 'Investment Returns': '📈',
                'Rental Income': '🏠', 'Side Hustle': '🚀', 'Gifts/Bonus': '🎁', 'Opening Balance': '🔄', 'Other Income': '💰',
                'Rent': '🏠', 'Transportation': '🚗', 'Food & Dining': '🍽️', 'Utilities': '⚡',
                'Healthcare': '🏥', 'Insurance': '🛡️', 'Shopping': '🛍️', 'Entertainment': '🎬',
                'Education': '📚', 'Personal Care': '💅', 'Travel': '✈️', 'Subscriptions': '📱',
                'Debt Payments': '💳', 'Savings': '🐷', 'Home': '🏠', 'Other Expenses': '📦'
            };

            const monthEmojis = {
                'January': '❄️', 'February': '💝', 'March': '🌸', 'April': '☀️',
                'May': '🔥', 'June': '🌧️', 'July': '💧', 'August': '🌾',
                'September': '🍃', 'October': '🎃', 'November': '🌙', 'December': '🎄'
            };

            const handleSubmit = () => {
                if (!formData.category || !formData.amount) return;

                // Validate date is within the selected month/year
                const selectedDate = new Date(formData.date);
                const selectedMonthIndex = monthNames.indexOf(selectedMonth);
                
                if (selectedDate.getFullYear() !== selectedYear || selectedDate.getMonth() !== selectedMonthIndex) {
                    alert(`Please select a date within ${selectedMonth} ${selectedYear}`);
                    return;
                }

                if (isEditMode && editingTransaction) {
                    // Update existing transaction
                    const updatedTransactions = transactions.map(t => 
                        t.id === editingTransaction.id 
                            ? { ...t, ...formData, amount: parseFloat(formData.amount) }
                            : t
                    );
                    setTransactions(updatedTransactions);
                    setIsEditMode(false);
                    setEditingTransaction(null);
                } else {
                    // Create new transaction
                    const newTransaction = {
                        id: Date.now(),
                        ...formData,
                        amount: parseFloat(formData.amount),
                        date: formData.date
                    };
                    setTransactions([newTransaction, ...transactions]);
                }

                // Reset form
                setFormData({
                    type: 'expense',
                    category: '',
                    amount: '',
                    description: '',
                    date: getDefaultDateForMonth(selectedYear, selectedMonth)
                });
                setShowMobileForm(false);
            };

            const deleteTransaction = (id) => {
                const transactionToDelete = transactions.find(t => t.id === id);
                
                // Prevent deletion of opening balance transactions
                if (transactionToDelete && transactionToDelete.isOpeningBalance) {
                    alert('Opening balance transactions cannot be deleted. They are automatically calculated from the previous month.');
                    return;
                }
                
                setTransactions(transactions.filter(t => t.id !== id));
            };

            const editTransaction = (transaction) => {
                // Prevent editing of opening balance transactions
                if (transaction.isOpeningBalance) {
                    alert('Opening balance transactions cannot be edited. They are automatically calculated from the previous month.');
                    return;
                }
                
                setEditingTransaction(transaction);
                setFormData({
                    type: transaction.type,
                    category: transaction.category,
                    amount: transaction.amount.toString(),
                    description: transaction.description || '',
                    date: transaction.date
                });
                setIsEditMode(true);
                setShowMobileForm(true);
            };

            const cancelEdit = () => {
                setIsEditMode(false);
                setEditingTransaction(null);
                setFormData({
                    type: 'expense',
                    category: '',
                    amount: '',
                    description: '',
                    date: getDefaultDateForMonth(selectedYear, selectedMonth)
                });
                setShowMobileForm(false);
            };

            // Calculate totals excluding opening balance for Income/Expense display
            const currentMonthIncome = transactions
                .filter(t => t.type === 'income' && !t.isOpeningBalance)
                .reduce((sum, t) => sum + t.amount, 0);

            const currentMonthExpenses = transactions
                .filter(t => t.type === 'expense' && !t.isOpeningBalance)
                .reduce((sum, t) => sum + t.amount, 0);

            // Get credit card expenses
            const creditCards = window.CloudSync.getCreditCards(currentUser, selectedYear, selectedMonth);
            const totalCreditExpenses = creditCards.reduce((sum, card) => 
                sum + card.expenses.reduce((cardSum, expense) => cardSum + expense.amount, 0), 0
            );

            // Calculate total balance including opening balance
            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);

            const totalExpenses = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);

            // Calculate adjusted balance (subtract credit card expenses from cash balance)
            const cashBalance = totalIncome - totalExpenses;
            const netBalance = cashBalance - totalCreditExpenses;

            // Get opening balance amount
            const openingBalanceTransaction = transactions.find(t => t.isOpeningBalance);
            const openingBalance = openingBalanceTransaction ? 
                (openingBalanceTransaction.type === 'income' ? openingBalanceTransaction.amount : -openingBalanceTransaction.amount) : 0;

            const getCategoryTotals = (type) => {
                const categories = type === 'income' ? incomeCategories : expenseCategories;
                return categories.map(category => {
                    // Exclude opening balance from charts
                    const categoryTransactions = transactions.filter(t => 
                        t.type === type && 
                        t.category === category && 
                        !t.isOpeningBalance
                    );
                    const total = categoryTransactions.reduce((sum, t) => sum + t.amount, 0);
                    return { category, total, count: categoryTransactions.length };
                }).filter(c => c.total > 0);
            };

            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: 'INR'
                }).format(amount);
            };

            const handleAddUser = () => {
                setUserRefresh(prev => prev + 1);
            };

            const handlePasswordChanged = () => {
                console.log('Password changed successfully');
            };

            const changeMonth = (direction) => {
                const currentIndex = monthNames.indexOf(selectedMonth);
                let newIndex, newYear = selectedYear;
                
                if (direction === 'prev') {
                    newIndex = currentIndex - 1;
                    if (newIndex < 0) {
                        newIndex = 11;
                        newYear = selectedYear - 1;
                        if (newYear < 2025) {
                            newYear = 2025;
                            newIndex = 0;
                        }
                    }
                } else {
                    newIndex = currentIndex + 1;
                    if (newIndex > 11) {
                        newIndex = 0;
                        newYear = selectedYear + 1;
                        if (newYear > 2030) {
                            newYear = 2030;
                            newIndex = 11;
                        }
                    }
                }
                
                setSelectedMonth(monthNames[newIndex]);
                setSelectedYear(newYear);
            };

            const getMonthSummary = (monthName) => {
                const monthData = window.CloudSync.getUserData(currentUser, selectedYear, monthName);
                const income = monthData.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expenses = monthData.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                return { income, expenses, balance: income - expenses, transactions: monthData.length };
            };

            const getDateConstraints = () => {
                const monthIndex = monthNames.indexOf(selectedMonth);
                const firstDay = new Date(selectedYear, monthIndex, 1);
                const lastDay = new Date(selectedYear, monthIndex + 1, 0);
                
                return {
                    min: firstDay.toISOString().split('T')[0],
                    max: lastDay.toISOString().split('T')[0]
                };
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
                    {/* Mobile Header */}
                    <div className="mobile-sticky-header bg-white px-4 py-3 sm:px-6">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="text-2xl">💰</div>
                                <div>
                                    <h1 className="text-lg font-bold text-gray-800">Monthly Tracker</h1>
                                    <p className="text-xs text-gray-600">Welcome, {userName}</p>
                                </div>
                            </div>
                            <button
                                onClick={() => setShowMobileMenu(true)}
                                className="p-2 hover:bg-gray-100 rounded-lg touch-target"
                            >
                                <Menu />
                            </button>
                        </div>

                        {/* Navigation Tabs */}
                        <div className="navigation-tabs mt-4">
                            <div className="flex">
                                <button
                                    onClick={() => setActiveTab('overview')}
                                    className={`nav-tab ${activeTab === 'overview' ? 'active' : ''}`}
                                >
                                    📊 Overview
                                </button>
                                <button
                                    onClick={() => setActiveTab('transactions')}
                                    className={`nav-tab ${activeTab === 'transactions' ? 'active' : ''}`}
                                >
                                    💸 Transactions
                                </button>
                                <button
                                    onClick={() => setActiveTab('creditcards')}
                                    className={`nav-tab ${activeTab === 'creditcards' ? 'active' : ''}`}
                                >
                                    💳 Credit Cards
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="p-4 pb-24">
                        {/* Add User Modal */}
                        {showAddUser && (
                            <AddUserForm 
                                onAddUser={handleAddUser}
                                onClose={() => setShowAddUser(false)}
                            />
                        )}

                        {/* Change Password Modal */}
                        {showChangePassword && (
                            <ChangePasswordForm 
                                currentUser={currentUser}
                                onClose={() => setShowChangePassword(false)}
                                onPasswordChanged={handlePasswordChanged}
                            />
                        )}

                        {/* Admin Credentials Panel */}
                        {isAdmin && showCredentials && (
                            <div className="bg-white rounded-xl shadow-lg p-4 mb-6 border-l-4 border-blue-500">
                                <h3 className="text-lg font-semibold text-gray-800 mb-4">User Management (Admin View)</h3>
                                <div className="space-y-3">
                                    {Object.entries(window.CloudSync.users).map(([username, user]) => (
                                        <div key={username} className="bg-gray-50 p-3 rounded-lg">
                                            <p className="font-medium text-gray-800">{user.name}</p>
                                            <p className="text-sm text-gray-600">Username: <span className="font-mono">{username}</span></p>
                                            <p className="text-sm text-gray-600">Password: <span className="font-mono">{user.password}</span></p>
                                            {user.isAdmin && <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Admin</span>}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Opening Balance Display */}
                        {openingBalance !== 0 && (
                            <div className="opening-balance-card rounded-xl shadow-lg p-4 mb-6 text-white">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <div className="flex items-center gap-2 mb-2">
                                            <span className="text-xl">🔄</span>
                                            <h3 className="text-sm font-semibold">Opening Balance</h3>
                                            <span className="carry-forward-badge">Carried Forward</span>
                                        </div>
                                        <p className="text-2xl font-bold">
                                            {openingBalance >= 0 ? '+' : ''}{formatCurrency(openingBalance)}
                                        </p>
                                        <p className="text-xs opacity-90">
                                            Balance from previous month
                                        </p>
                                    </div>
                                    <div className="text-3xl opacity-80">
                                        <ArrowRight />
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Month Navigation */}
                        <div className="bg-white rounded-xl shadow-lg p-4 mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <button
                                    onClick={() => changeMonth('prev')}
                                    className="flex items-center gap-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors touch-target"
                                >
                                    <ChevronLeft />
                                    <span className="text-sm">Prev</span>
                                </button>
                                
                                <div className="text-center">
                                    <div className="text-xl font-bold text-gray-800 flex items-center gap-2 justify-center mb-2">
                                        <span>{monthEmojis[selectedMonth]}</span>
                                        <span>{selectedMonth} {selectedYear}</span>
                                    </div>
                                    
                                    <div className="flex items-center justify-center gap-2">
                                        <label className="text-xs font-medium text-gray-600">Year:</label>
                                        <select
                                            value={selectedYear}
                                            onChange={(e) => setSelectedYear(parseInt(e.target.value))}
                                            className="px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white"
                                        >
                                            {[2025, 2026, 2027, 2028, 2029, 2030].map(year => (
                                                <option key={year} value={year}>{year}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                                
                                <button
                                    onClick={() => changeMonth('next')}
                                    className="flex items-center gap-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors touch-target"
                                >
                                    <span className="text-sm">Next</span>
                                    <ChevronRight />
                                </button>
                            </div>

                            {/* Scrollable Month Grid */}
                            <div>
                                <div className="text-center text-xs text-gray-600 mb-3">
                                    <span className="bg-gray-100 px-2 py-1 rounded-full">
                                        📅 {selectedYear} - Tap any month to switch
                                    </span>
                                </div>
                                <div className="grid grid-cols-3 sm:grid-cols-4 gap-2">
                                    {monthNames.map((month) => {
                                        const summary = getMonthSummary(month);
                                        const isSelected = month === selectedMonth;
                                        const hasData = summary.transactions > 0;
                                        
                                        return (
                                            <button
                                                key={month}
                                                onClick={() => setSelectedMonth(month)}
                                                className={`month-tab p-3 rounded-lg text-center transition-all touch-feedback ${
                                                    isSelected 
                                                        ? 'bg-blue-500 text-white shadow-lg' 
                                                        : hasData 
                                                            ? 'bg-green-100 hover:bg-green-200 text-green-800'
                                                            : 'bg-gray-100 hover:bg-gray-200 text-gray-600'
                                                }`}
                                            >
                                                <div className="text-lg mb-1">{monthEmojis[month]}</div>
                                                <div className="text-xs font-medium">{month.slice(0, 3)}</div>
                                                {hasData && (
                                                    <div className="text-xs mt-1">
                                                        <div>{summary.transactions}</div>
                                                        <div className={summary.balance >= 0 ? 'text-green-600' : 'text-red-600'}>
                                                            {isSelected ? (summary.balance >= 0 ? '+' : '') + formatCurrency(summary.balance).slice(1, 6) + '...' : '●'}
                                                        </div>
                                                    </div>
                                                )}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>

                        {/* Tab Content */}
                        {activeTab === 'overview' && (
                            <>
                                {/* Summary Cards */}
                                <div className="grid grid-cols-2 gap-4 mb-6">
                                    <div className="bg-white rounded-xl shadow-lg p-4 border-l-4 border-green-500">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <p className="text-xs text-gray-600 mb-1">Income</p>
                                                <p className="text-lg font-bold text-green-600">
                                                    {currentMonthIncome > 99999 ? `₹${(currentMonthIncome/1000).toFixed(0)}K` : formatCurrency(currentMonthIncome)}
                                                </p>
                                                <p className="text-xs text-gray-500">
                                                    This month only
                                                </p>
                                            </div>
                                            <div className="text-green-500">
                                                <TrendingUp />
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-white rounded-xl shadow-lg p-4 border-l-4 border-red-500">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <p className="text-xs text-gray-600 mb-1">Cash Expenses</p>
                                                <p className="text-lg font-bold text-red-600">
                                                    {currentMonthExpenses > 99999 ? `₹${(currentMonthExpenses/1000).toFixed(0)}K` : formatCurrency(currentMonthExpenses)}
                                                </p>
                                                <p className="text-xs text-gray-500">
                                                    This month only
                                                </p>
                                            </div>
                                            <div className="text-red-500">
                                                <TrendingDown />
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-white rounded-xl shadow-lg p-4 border-l-4 border-purple-500">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <p className="text-xs text-gray-600 mb-1">Credit Expenses</p>
                                                <p className="text-lg font-bold text-purple-600">
                                                    {totalCreditExpenses > 99999 ? `₹${(totalCreditExpenses/1000).toFixed(0)}K` : formatCurrency(totalCreditExpenses)}
                                                </p>
                                                <p className="text-xs text-gray-500">
                                                    Credit cards
                                                </p>
                                            </div>
                                            <div className="text-purple-500">
                                                <CreditCard />
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-white rounded-xl shadow-lg p-4 border-l-4 border-blue-500">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <p className="text-xs text-gray-600 mb-1">Net Balance</p>
                                                <div className="flex items-center gap-2">
                                                    <p className={`text-lg font-bold ${netBalance >= 0 ? 'text-blue-600' : 'text-red-600'}`}>
                                                        {showBalance ? 
                                                            (Math.abs(netBalance) > 99999 ? `₹${(netBalance/1000).toFixed(0)}K` : formatCurrency(netBalance))
                                                            : '****'
                                                        }
                                                    </p>
                                                    <button
                                                        onClick={() => setShowBalance(!showBalance)}
                                                        className="text-gray-400 hover:text-gray-600 touch-target"
                                                    >
                                                        {showBalance ? <EyeOff /> : <Eye />}
                                                    </button>
                                                </div>
                                                {/* Balance breakdown */}
                                                {showBalance && (
                                                    <div className="balance-breakdown">
                                                        {openingBalance !== 0 && (
                                                            <div className="balance-component opening">
                                                                <span>Opening:</span>
                                                                <span>{openingBalance >= 0 ? '+' : ''}₹{openingBalance.toLocaleString('en-IN')}</span>
                                                            </div>
                                                        )}
                                                        <div className="balance-component current">
                                                            <span>Cash flow:</span>
                                                            <span>{(currentMonthIncome - currentMonthExpenses) >= 0 ? '+' : ''}₹{(currentMonthIncome - currentMonthExpenses).toLocaleString('en-IN')}</span>
                                                        </div>
                                                        <div className="balance-component current">
                                                            <span>Credit debt:</span>
                                                            <span>-₹{totalCreditExpenses.toLocaleString('en-IN')}</span>
                                                        </div>
                                                        <div className="balance-component total">
                                                            <span>Net total:</span>
                                                            <span>{netBalance >= 0 ? '+' : ''}₹{netBalance.toLocaleString('en-IN')}</span>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                            <div className="text-blue-500">
                                                <RupeeSign />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Charts Section - Mobile Optimized */}
                                <div className="space-y-6 mb-6">
                                    <div className="bg-white rounded-xl shadow-lg p-4">
                                        <h3 className="text-base font-semibold text-gray-800 mb-4 text-center">
                                            Income Distribution - {selectedMonth}
                                        </h3>
                                        <PieChart 
                                            data={getCategoryTotals('income')} 
                                            title="Income Distribution"
                                            type="income"
                                        />
                                    </div>

                                    <div className="bg-white rounded-xl shadow-lg p-4">
                                        <h3 className="text-base font-semibold text-gray-800 mb-4 text-center">
                                            Cash Expense Distribution - {selectedMonth}
                                        </h3>
                                        <PieChart 
                                            data={getCategoryTotals('expense')} 
                                            title="Expense Distribution"
                                            type="expense"
                                        />
                                    </div>
                                </div>
                            </>
                        )}

                        {activeTab === 'transactions' && (
                            <div className="bg-white rounded-xl shadow-lg p-4">
                                <h3 className="text-base font-semibold text-gray-800 mb-4">
                                    {selectedMonth} {selectedYear} Cash Transactions
                                </h3>
                                
                                {transactions.length === 0 ? (
                                    <div className="text-center py-12 text-gray-500">
                                        <div className="text-4xl mb-2">{monthEmojis[selectedMonth]}</div>
                                        <p className="text-sm">No transactions for {selectedMonth} yet.</p>
                                        <p className="text-xs mt-2">Tap the + button to add your first transaction!</p>
                                    </div>
                                ) : (
                                    <div className="space-y-3 mobile-scroll">
                                        {transactions.map(transaction => (
                                            <div
                                                key={transaction.id}
                                                className={`flex items-center justify-between p-3 rounded-lg border-l-4 ${
                                                    transaction.type === 'income' 
                                                        ? transaction.isOpeningBalance 
                                                            ? 'bg-emerald-50 border-emerald-500' 
                                                            : 'bg-green-50 border-green-500'
                                                        : transaction.isOpeningBalance 
                                                            ? 'bg-orange-50 border-orange-500'
                                                            : 'bg-red-50 border-red-500'
                                                }`}
                                            >
                                                <div className="flex items-center gap-3 flex-1 min-w-0">
                                                    <div className="text-xl">
                                                        {categoryIcons[transaction.category]}
                                                    </div>
                                                    <div className="min-w-0 flex-1">
                                                        <div className="flex items-center gap-2">
                                                            <p className="font-medium text-gray-800 text-sm truncate">{transaction.category}</p>
                                                            {transaction.isOpeningBalance && (
                                                                <span className="carry-forward-badge">CF</span>
                                                            )}
                                                        </div>
                                                        {transaction.description && (
                                                            <p className="text-xs text-gray-600 truncate">{transaction.description}</p>
                                                        )}
                                                        <p className="text-xs text-gray-500">{transaction.date}</p>
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-2 ml-2">
                                                    <span className={`font-bold text-sm ${
                                                        transaction.type === 'income' ? 'text-green-600' : 'text-red-600'
                                                    }`}>
                                                        {transaction.type === 'income' ? '+' : '-'}
                                                        {transaction.amount > 99999 ? `₹${(transaction.amount/1000).toFixed(0)}K` : `₹${transaction.amount.toLocaleString('en-IN')}`}
                                                    </span>
                                                    {!transaction.isOpeningBalance && (
                                                        <>
                                                            <button
                                                                onClick={() => editTransaction(transaction)}
                                                                className="text-blue-400 hover:text-blue-600 p-1 touch-target"
                                                                title="Edit transaction"
                                                            >
                                                                <Edit />
                                                            </button>
                                                            <button
                                                                onClick={() => deleteTransaction(transaction.id)}
                                                                className="text-red-400 hover:text-red-600 p-1 touch-target"
                                                                title="Delete transaction"
                                                            >
                                                                <Trash2 />
                                                            </button>
                                                        </>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'creditcards' && (
                            <CreditCardManager 
                                currentUser={currentUser} 
                                selectedYear={selectedYear} 
                                selectedMonth={selectedMonth} 
                            />
                        )}
                    </div>

                    {/* Mobile FAB - only show on transactions and credit cards tabs */}
                    {(activeTab === 'transactions' || activeTab === 'creditcards') && (
                        <button
                            onClick={() => {
                                if (activeTab === 'transactions') {
                                    setIsEditMode(false);
                                    setEditingTransaction(null);
                                    setFormData({
                                        type: 'expense',
                                        category: '',
                                        amount: '',
                                        description: '',
                                        date: getDefaultDateForMonth(selectedYear, selectedMonth)
                                    });
                                    setShowMobileForm(true);
                                }
                            }}
                            className="mobile-fab w-14 h-14 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-full hover:from-blue-600 hover:to-purple-700 transition-all duration-200 touch-feedback"
                        >
                            <Plus />
                        </button>
                    )}

                    {/* Mobile Menu Sheet */}
                    <MobileBottomSheet
                        isOpen={showMobileMenu}
                        onClose={() => setShowMobileMenu(false)}
                        title="Menu"
                    >
                        <div className="space-y-4">
                            <button
                                onClick={() => {
                                    setShowMobileMenu(false);
                                    setShowChangePassword(true);
                                }}
                                className="w-full flex items-center gap-3 p-3 text-left hover:bg-gray-50 rounded-lg touch-target"
                            >
                                <Lock />
                                <span>Change Password</span>
                            </button>
                            
                            {isAdmin && (
                                <>
                                    <button
                                        onClick={() => {
                                            setShowMobileMenu(false);
                                            setShowAddUser(true);
                                        }}
                                        className="w-full flex items-center gap-3 p-3 text-left hover:bg-gray-50 rounded-lg touch-target"
                                    >
                                        <UserPlus />
                                        <span>Add User</span>
                                    </button>
                                    <button
                                        onClick={() => {
                                            setShowCredentials(!showCredentials);
                                            setShowMobileMenu(false);
                                        }}
                                        className="w-full flex items-center gap-3 p-3 text-left hover:bg-gray-50 rounded-lg touch-target"
                                    >
                                        <Eye />
                                        <span>{showCredentials ? 'Hide' : 'Show'} Users</span>
                                    </button>
                                </>
                            )}
                            
                            <button
                                onClick={() => {
                                    setShowMobileMenu(false);
                                    onLogout();
                                }}
                                className="w-full flex items-center gap-3 p-3 text-left hover:bg-gray-50 rounded-lg text-red-600 touch-target"
                            >
                                <LogOut />
                                <span>Logout</span>
                            </button>
                        </div>
                    </MobileBottomSheet>

                    {/* Mobile Form Sheet - only for cash transactions */}
                    {activeTab === 'transactions' && (
                        <MobileBottomSheet
                            isOpen={showMobileForm}
                            onClose={() => {
                                if (isEditMode) {
                                    cancelEdit();
                                } else {
                                    setShowMobileForm(false);
                                }
                            }}
                            title={isEditMode ? `Edit Transaction` : `Add Cash Transaction to ${selectedMonth}`}
                        >
                            <div className="space-y-4">
                                {isEditMode && (
                                    <div className="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded-lg text-sm">
                                        <div className="flex items-center gap-2">
                                            <Edit />
                                            <span>Editing transaction from {editingTransaction?.date}</span>
                                        </div>
                                    </div>
                                )}

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Type</label>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => setFormData({...formData, type: 'income', category: ''})}
                                            className={`flex-1 py-3 px-4 rounded-lg font-medium transition-all touch-feedback ${
                                                formData.type === 'income'
                                                    ? 'bg-green-500 text-white'
                                                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                            }`}
                                        >
                                            Income
                                        </button>
                                        <button
                                            onClick={() => setFormData({...formData, type: 'expense', category: ''})}
                                            className={`flex-1 py-3 px-4 rounded-lg font-medium transition-all touch-feedback ${
                                                formData.type === 'expense'
                                                    ? 'bg-red-500 text-white'
                                                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                            }`}
                                        >
                                            Expense
                                        </button>
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                    <select
                                        value={formData.category}
                                        onChange={(e) => setFormData({...formData, category: e.target.value})}
                                        className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    >
                                        <option value="">Select category</option>
                                        {(formData.type === 'income' ? incomeCategories : expenseCategories)
                                            .filter(cat => cat !== 'Opening Balance') // Hide Opening Balance from manual selection
                                            .map(cat => (
                                            <option key={cat} value={cat}>{categoryIcons[cat]} {cat}</option>
                                        ))}
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Amount (₹)</label>
                                    <input
                                        type="number"
                                        step="0.01"
                                        value={formData.amount}
                                        onChange={(e) => setFormData({...formData, amount: e.target.value})}
                                        className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="0.00"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                    <input
                                        type="text"
                                        value={formData.description}
                                        onChange={(e) => setFormData({...formData, description: e.target.value})}
                                        className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="Optional description"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Date (within {selectedMonth} {selectedYear})
                                    </label>
                                    <input
                                        type="date"
                                        value={formData.date}
                                        onChange={(e) => setFormData({...formData, date: e.target.value})}
                                        className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        min={getDateConstraints().min}
                                        max={getDateConstraints().max}
                                    />
                                    <p className="text-xs text-gray-500 mt-1">
                                        Select a date between {getDateConstraints().min} and {getDateConstraints().max}
                                    </p>
                                </div>

                                <div className="flex gap-3">
                                    <button
                                        onClick={handleSubmit}
                                        disabled={!formData.category || !formData.amount}
                                        className="flex-1 bg-gradient-to-r from-green-500 to-blue-600 text-white py-4 px-4 rounded-lg hover:from-green-600 hover:to-blue-700 transition-all duration-200 font-semibold touch-feedback disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                    >
                                        {isEditMode ? <Save /> : <Plus />}
                                        <span>{isEditMode ? 'Update' : 'Add'} Transaction</span>
                                    </button>
                                    
                                    {isEditMode && (
                                        <button
                                            onClick={cancelEdit}
                                            className="flex-1 bg-gray-500 text-white py-4 px-4 rounded-lg hover:bg-gray-600 transition-all duration-200 font-semibold touch-feedback"
                                        >
                                            Cancel
                                        </button>
                                    )}
                                </div>
                            </div>
                        </MobileBottomSheet>
                    )}
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [userName, setUserName] = useState('');
            const [isAdmin, setIsAdmin] = useState(false);

            // Check if user is already logged in
            useEffect(() => {
                const savedUser = localStorage.getItem('currentUser');
                const savedUserName = localStorage.getItem('currentUserName');
                const savedIsAdmin = localStorage.getItem('currentIsAdmin') === 'true';
                if (savedUser && savedUserName) {
                    setCurrentUser(savedUser);
                    setUserName(savedUserName);
                    setIsAdmin(savedIsAdmin);
                }
            }, []);

            const handleLogin = (username, name, adminStatus) => {
                setCurrentUser(username);
                setUserName(name);
                setIsAdmin(adminStatus);
                localStorage.setItem('currentUser', username);
                localStorage.setItem('currentUserName', name);
                localStorage.setItem('currentIsAdmin', adminStatus.toString());
            };

            const handleLogout = () => {
                setCurrentUser(null);
                setUserName('');
                setIsAdmin(false);
                localStorage.removeItem('currentUser');
                localStorage.removeItem('currentUserName');
                localStorage.removeItem('currentIsAdmin');
            };

            if (!currentUser) {
                return <LoginForm onLogin={handleLogin} />;
            }

            return (
                <MonthlyTracker 
                    currentUser={currentUser} 
                    userName={userName} 
                    isAdmin={isAdmin}
                    onLogout={handleLogout} 
                />
            );
        };

        // Hide loading screen and render app
        setTimeout(() => {
            document.body.classList.add('app-loaded');
            ReactDOM.render(<App />, document.getElementById('root'));
        }, 1500);

        // Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'monthly-tracker-v7';
                    const urlsToCache = ['/'];
                    
                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => cache.addAll(urlsToCache))
                        );
                    });
                    
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => response || fetch(event.request))
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            });
        }

        // Add touch event handling for better mobile experience
        document.addEventListener('touchstart', function(){}, {passive: true});
        
        // Prevent double-tap zoom
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            var now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>
