<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monthly Tracker</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#3B82F6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Monthly Tracker">
    
    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.22.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        .icon { width: 20px; height: 20px; display: inline-block; }
        .icon-lg { width: 32px; height: 32px; }
        .icon-sm { width: 16px; height: 16px; }
        
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #3B82F6, #8B5CF6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .app-loaded .loading-screen {
            display: none;
        }

        .month-tab {
            transition: all 0.3s ease;
            min-height: 80px;
        }

        .month-tab:hover {
            transform: translateY(-2px);
        }

        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }

        /* Mobile-specific enhancements */
        @media (max-width: 768px) {
            .chart-container {
                height: 200px;
            }
            
            .mobile-sticky-header {
                position: -webkit-sticky;
                position: sticky;
                top: 0;
                z-index: 40;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            }
            
            .mobile-scroll {
                max-height: 60vh;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .mobile-fab {
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 50;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            }
            
            .mobile-sheet {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-radius: 20px 20px 0 0;
                z-index: 60;
                transform: translateY(100%);
                transition: transform 0.3s ease;
                max-height: 85vh;
                overflow-y: auto;
            }
            
            .mobile-sheet.open {
                transform: translateY(0);
            }
            
            .mobile-backdrop {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 55;
                opacity: 0;
                transition: opacity 0.3s ease;
                pointer-events: none;
            }
            
            .mobile-backdrop.open {
                opacity: 1;
                pointer-events: all;
            }
            
            .touch-target {
                min-height: 44px;
                min-width: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .month-tab {
                min-height: 70px;
            }
        }

        /* Custom scrollbar for mobile */
        .mobile-scroll::-webkit-scrollbar {
            width: 4px;
        }
        
        .mobile-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 2px;
        }
        
        .mobile-scroll::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 2px;
        }
        
        .mobile-scroll::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* Swipe indicator */
        .swipe-indicator {
            width: 40px;
            height: 4px;
            background: #ccc;
            border-radius: 2px;
            margin: 0 auto;
        }

        /* Better touch feedback */
        .touch-feedback:active {
            transform: scale(0.95);
            transition: transform 0.1s ease;
        }

        /* Improved input focus for mobile */
        input:focus, select:focus, textarea:focus {
            transform: none !important;
            zoom: 1;
        }

        /* Prevent zoom on input focus on iOS */
        @media screen and (-webkit-min-device-pixel-ratio: 0) {
            select, textarea, input[type="text"], input[type="password"], 
            input[type="datetime"], input[type="datetime-local"], 
            input[type="date"], input[type="month"], input[type="time"], 
            input[type="week"], input[type="number"], input[type="email"], 
            input[type="url"] {
                font-size: 16px;
            }
        }

        .year-summary-expanded {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="text-center">
            <div class="loading-spinner text-6xl mb-4">💰</div>
            <h1 class="text-2xl font-bold">Monthly Tracker</h1>
            <p class="text-blue-200">Loading your financial dashboard...</p>
        </div>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Simple cloud sync simulation using a global object
        window.CloudSync = window.CloudSync || {
            data: {},
            users: {
                'admin': { password: 'admin123', name: 'Administrator', isAdmin: true },
                'arpbat': { password: 'arpitha7', name: 'Arpitha Battu' },
                'sarvesh': { password: 'sarvesh123', name: 'Sarvesh Kommawar' },
                'vanshika': { password: 'vanshika123', name: 'Vanshika Battu' }
            },
            
            // Save user data to cloud (organized by year and month)
            saveUserData: function(username, year, month, transactions) {
                if (!this.data[username]) this.data[username] = {};
                if (!this.data[username][year]) this.data[username][year] = {};
                this.data[username][year][month] = transactions;
                
                // Also save to localStorage as backup
                localStorage.setItem(`monthlyTracker_${username}_${year}_${month}`, JSON.stringify(transactions));
            },
            
            // Get user data from cloud (for specific year and month)
            getUserData: function(username, year, month) {
                // Try cloud first
                if (this.data[username] && this.data[username][year] && this.data[username][year][month]) {
                    return this.data[username][year][month];
                }
                
                // Then localStorage as fallback
                try {
                    const saved = localStorage.getItem(`monthlyTracker_${username}_${year}_${month}`);
                    const data = saved ? JSON.parse(saved) : [];
                    
                    // Sync to cloud
                    if (!this.data[username]) this.data[username] = {};
                    if (!this.data[username][year]) this.data[username][year] = {};
                    this.data[username][year][month] = data;
                    
                    return data;
                } catch (error) {
                    return [];
                }
            },

            // Get all data for a user (all years and months)
            getAllUserData: function(username) {
                const allData = {};
                
                // Load from cloud and localStorage for years 2025-2030
                for (let year = 2025; year <= 2030; year++) {
                    allData[year] = {};
                    for (let month = 0; month < 12; month++) {
                        const monthName = ['January', 'February', 'March', 'April', 'May', 'June',
                                         'July', 'August', 'September', 'October', 'November', 'December'][month];
                        allData[year][monthName] = this.getUserData(username, year, monthName);
                    }
                }
                
                return allData;
            },
            
            // Add new user
            addUser: function(username, password, name, isAdmin = false) {
                this.users[username] = { password, name, isAdmin };
                localStorage.setItem('userDatabase', JSON.stringify(this.users));
                return true;
            },

            // Change password
            changePassword: function(username, oldPassword, newPassword) {
                if (!this.users[username]) {
                    return { success: false, error: 'User not found' };
                }
                
                if (this.users[username].password !== oldPassword) {
                    return { success: false, error: 'Current password is incorrect' };
                }
                
                if (newPassword.length < 6) {
                    return { success: false, error: 'New password must be at least 6 characters' };
                }
                
                this.users[username].password = newPassword;
                localStorage.setItem('userDatabase', JSON.stringify(this.users));
                return { success: true };
            },
            
            // Load users from localStorage on app start
            loadUsers: function() {
                try {
                    const saved = localStorage.getItem('userDatabase');
                    if (saved) {
                        this.users = { ...this.users, ...JSON.parse(saved) };
                    }
                } catch (error) {
                    console.log('Error loading users from localStorage');
                }
            }
        };

        // Initialize cloud sync
        window.CloudSync.loadUsers();
        
        // Icon components
        const PlusCircle = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="16"></line>
                <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
        );

        const Plus = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const TrendingUp = () => (
            <svg className="icon-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                <polyline points="17 6 23 6 23 12"></polyline>
            </svg>
        );

        const TrendingDown = () => (
            <svg className="icon-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
                <polyline points="17 18 23 18 23 12"></polyline>
            </svg>
        );

        const RupeeSign = () => (
            <svg className="icon-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M6 3h12M6 8h12m-12 5a3 3 0 1 0 0-6m0 6a3 3 0 1 1 0 6M18 13l-8 8"/>
            </svg>
        );

        const Eye = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
            </svg>
        );

        const EyeOff = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                <line x1="1" y1="1" x2="23" y2="23"></line>
            </svg>
        );

        const Trash2 = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="3,6 5,6 21,6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        const User = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
        );

        const LogOut = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16,17 21,12 16,7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
        );

        const UserPlus = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <line x1="20" y1="8" x2="20" y2="14"></line>
                <line x1="23" y1="11" x2="17" y2="11"></line>
            </svg>
        );

        const Lock = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <circle cx="12" cy="16" r="1"></circle>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
        );

        const Calendar = () => (
            <svg className="icon-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        );

        const ChevronLeft = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="15,18 9,12 15,6"></polyline>
            </svg>
        );

        const ChevronRight = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="9,18 15,12 9,6"></polyline>
            </svg>
        );

        const ChevronDown = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="6,9 12,15 18,9"></polyline>
            </svg>
        );

        const ChevronUp = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <polyline points="18,15 12,9 6,15"></polyline>
            </svg>
        );

        const X = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        );

        const Menu = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        );

        const BarChart3 = () => (
            <svg className="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path d="M3 3v18h18"></path>
                <path d="M18 17V9"></path>
                <path d="M13 17V5"></path>
                <path d="M8 17v-3"></path>
            </svg>
        );

        // Pie Chart Component
        const PieChart = ({ data, title, type }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                if (data.length === 0) return;

                const ctx = chartRef.current.getContext('2d');
                
                const colors = type === 'income' ? [
                    '#10B981', '#059669', '#047857', '#065F46', '#064E3B', '#16A34A', '#15803D', '#166534'
                ] : [
                    '#EF4444', '#DC2626', '#B91C1C', '#991B1B', '#7F1D1D', '#F97316', '#EA580C', '#C2410C'
                ];

                chartInstance.current = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: data.map(item => item.category),
                        datasets: [{
                            data: data.map(item => item.total),
                            backgroundColor: colors.slice(0, data.length),
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    usePointStyle: true,
                                    font: {
                                        size: window.innerWidth < 768 ? 10 : 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                                        return `${context.label}: ₹${context.parsed.toLocaleString('en-IN')} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [data, type]);

            if (data.length === 0) {
                return (
                    <div className="chart-container flex items-center justify-center">
                        <div className="text-center text-gray-500">
                            <div className="text-4xl mb-2">📊</div>
                            <p className="text-sm">No {type} data for this month</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="chart-container">
                    <canvas ref={chartRef}></canvas>
                </div>
            );
        };

        // Mobile-Optimized Login Component
        const LoginForm = ({ onLogin }) => {
            const [loginData, setLoginData] = useState({ username: '', password: '' });
            const [error, setError] = useState('');

            const handleLogin = () => {
                const { username, password } = loginData;
                
                if (!username || !password) {
                    setError('Please enter both username and password');
                    return;
                }

                if (window.CloudSync.users[username] && window.CloudSync.users[username].password === password) {
                    onLogin(username, window.CloudSync.users[username].name, window.CloudSync.users[username].isAdmin || false);
                    setError('');
                } else {
                    setError('Invalid username or password');
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="text-6xl mb-4">💰</div>
                            <h1 className="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">Monthly Tracker</h1>
                            <p className="text-gray-600 text-sm sm:text-base">Sign in to access your financial data</p>
                        </div>

                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                <input
                                    type="text"
                                    value={loginData.username}
                                    onChange={(e) => setLoginData({...loginData, username: e.target.value})}
                                    onKeyPress={handleKeyPress}
                                    className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Enter username"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input
                                    type="password"
                                    value={loginData.password}
                                    onChange={(e) => setLoginData({...loginData, password: e.target.value})}
                                    onKeyPress={handleKeyPress}
                                    className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Enter password"
                                />
                            </div>

                            {error && (
                                <div className="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm">
                                    {error}
                                </div>
                            )}

                            <button
                                onClick={handleLogin}
                                className="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-4 px-4 rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all duration-200 font-semibold text-base touch-feedback"
                            >
                                Sign In
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Mobile-Optimized Add User Form Component
        const AddUserForm = ({ onAddUser, onClose }) => {
            const [userData, setUserData] = useState({
                username: '',
                password: '',
                name: '',
                isAdmin: false
            });
            const [error, setError] = useState('');

            const handleSubmit = () => {
                const { username, password, name } = userData;
                
                if (!username || !password || !name) {
                    setError('Please fill all required fields');
                    return;
                }

                if (window.CloudSync.users[username]) {
                    setError('Username already exists');
                    return;
                }

                if (username.length < 3) {
                    setError('Username must be at least 3 characters');
                    return;
                }

                if (password.length < 6) {
                    setError('Password must be at least 6 characters');
                    return;
                }

                window.CloudSync.addUser(username, password, name, userData.isAdmin);
                onAddUser();
                onClose();
                setError('');
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-xl font-bold text-gray-800">Add New User</h3>
                            <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg touch-target">
                                <X />
                            </button>
                        </div>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Full Name *</label>
                                <input
                                    type="text"
                                    value={userData.name}
                                    onChange={(e) => setUserData({...userData, name: e.target.value})}
                                    className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Enter full name"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Username *</label>
                                <input
                                    type="text"
                                    value={userData.username}
                                    onChange={(e) => setUserData({...userData, username: e.target.value.toLowerCase()})}
                                    className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Enter username (min 3 chars)"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Password *</label>
                                <input
                                    type="password"
                                    value={userData.password}
                                    onChange={(e) => setUserData({...userData, password: e.target.value})}
                                    className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Enter password (min 6 chars)"
                                />
                            </div>

                            <div className="flex items-center touch-target">
                                <input
                                    type="checkbox"
                                    id="isAdmin"
                                    checked={userData.isAdmin}
                                    onChange={(e) => setUserData({...userData, isAdmin: e.target.checked})}
                                    className="h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                                />
                                <label htmlFor="isAdmin" className="ml-3 block text-sm text-gray-700">
                                    Make this user an admin
                                </label>
                            </div>

                            {error && (
                                <div className="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm">
                                    {error}
                                </div>
                            )}

                            <div className="flex gap-3">
                                <button
                                    onClick={handleSubmit}
                                    className="flex-1 bg-gradient-to-r from-green-500 to-blue-600 text-white py-4 px-4 rounded-lg hover:from-green-600 hover:to-blue-700 transition-all duration-200 font-semibold touch-feedback"
                                >
                                    Add User
                                </button>
                                <button
                                    onClick={onClose}
                                    className="flex-1 bg-gray-500 text-white py-4 px-4 rounded-lg hover:bg-gray-600 transition-all duration-200 font-semibold touch-feedback"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Mobile-Optimized Change Password Form Component
        const ChangePasswordForm = ({ currentUser, onClose, onPasswordChanged }) => {
            const [passwordData, setPasswordData] = useState({
                currentPassword: '',
                newPassword: '',
                confirmPassword: ''
            });
            const [error, setError] = useState('');
            const [success, setSuccess] = useState(false);

            const handleSubmit = () => {
                const { currentPassword, newPassword, confirmPassword } = passwordData;
                
                if (!currentPassword || !newPassword || !confirmPassword) {
                    setError('Please fill all fields');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    setError('New passwords do not match');
                    return;
                }

                if (newPassword.length < 6) {
                    setError('New password must be at least 6 characters');
                    return;
                }

                if (currentPassword === newPassword) {
                    setError('New password must be different from current password');
                    return;
                }

                const result = window.CloudSync.changePassword(currentUser, currentPassword, newPassword);
                
                if (result.success) {
                    setSuccess(true);
                    setError('');
                    setTimeout(() => {
                        onPasswordChanged();
                        onClose();
                    }, 2000);
                } else {
                    setError(result.error);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    handleSubmit();
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
                        <div className="flex items-center justify-between mb-4">
                            <div className="flex items-center gap-2">
                                <Lock />
                                <h3 className="text-xl font-bold text-gray-800">Change Password</h3>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg touch-target">
                                <X />
                            </button>
                        </div>
                        
                        {success ? (
                            <div className="text-center py-8">
                                <div className="text-4xl mb-4">✅</div>
                                <h4 className="text-lg font-semibold text-green-600 mb-2">Password Changed Successfully!</h4>
                                <p className="text-gray-600">You can now use your new password to login.</p>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Current Password *</label>
                                    <input
                                        type="password"
                                        value={passwordData.currentPassword}
                                        onChange={(e) => setPasswordData({...passwordData, currentPassword: e.target.value})}
                                        onKeyPress={handleKeyPress}
                                        className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="Enter current password"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">New Password *</label>
                                    <input
                                        type="password"
                                        value={passwordData.newPassword}
                                        onChange={(e) => setPasswordData({...passwordData, newPassword: e.target.value})}
                                        onKeyPress={handleKeyPress}
                                        className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="Enter new password (min 6 chars)"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Confirm New Password *</label>
                                    <input
                                        type="password"
                                        value={passwordData.confirmPassword}
                                        onChange={(e) => setPasswordData({...passwordData, confirmPassword: e.target.value})}
                                        onKeyPress={handleKeyPress}
                                        className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="Confirm new password"
                                    />
                                </div>

                                {error && (
                                    <div className="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg text-sm">
                                        {error}
                                    </div>
                                )}

                                <div className="flex gap-3">
                                    <button
                                        onClick={handleSubmit}
                                        className="flex-1 bg-gradient-to-r from-blue-500 to-purple-600 text-white py-4 px-4 rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all duration-200 font-semibold touch-feedback"
                                    >
                                        Change Password
                                    </button>
                                    <button
                                        onClick={onClose}
                                        className="flex-1 bg-gray-500 text-white py-4 px-4 rounded-lg hover:bg-gray-600 transition-all duration-200 font-semibold touch-feedback"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Mobile Bottom Sheet Component
        const MobileBottomSheet = ({ isOpen, onClose, children, title }) => {
            return (
                <>
                    <div className={`mobile-backdrop ${isOpen ? 'open' : ''}`} onClick={onClose}></div>
                    <div className={`mobile-sheet ${isOpen ? 'open' : ''}`}>
                        <div className="p-4">
                            <div className="swipe-indicator mb-4"></div>
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-semibold text-gray-800">{title}</h3>
                                <button onClick={onClose} className="p-2 hover:bg-gray-100 rounded-lg touch-target">
                                    <X />
                                </button>
                            </div>
                            {children}
                        </div>
                    </div>
                </>
            );
        };

        // Main Mobile-Enhanced Tracker Component
        const MonthlyTracker = ({ currentUser, userName, isAdmin, onLogout }) => {
            const currentDate = new Date();
            const defaultYear = Math.max(2025, Math.min(currentDate.getFullYear(), 2030));
            const currentMonthIndex = currentDate.getMonth();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            const [selectedYear, setSelectedYear] = useState(defaultYear);
            const [selectedMonth, setSelectedMonth] = useState(monthNames[currentMonthIndex]);
            const [transactions, setTransactions] = useState(() => 
                window.CloudSync.getUserData(currentUser, defaultYear, monthNames[currentMonthIndex])
            );
            const [showMobileForm, setShowMobileForm] = useState(false);
            const [showMobileMenu, setShowMobileMenu] = useState(false);
            const [formData, setFormData] = useState({
                type: 'expense',
                category: '',
                amount: '',
                description: '',
                date: new Date().toISOString().split('T')[0]
            });
            const [showBalance, setShowBalance] = useState(true);
            const [showCredentials, setShowCredentials] = useState(false);
            const [showAddUser, setShowAddUser] = useState(false);
            const [showChangePassword, setShowChangePassword] = useState(false);
            const [userRefresh, setUserRefresh] = useState(0);
            const [showYearSummaryExpanded, setShowYearSummaryExpanded] = useState(false);

            // Helper function to get the default date for selected month/year
            const getDefaultDateForMonth = (year, month) => {
                const monthIndex = monthNames.indexOf(month);
                const date = new Date(year, monthIndex, 1);
                return date.toISOString().split('T')[0];
            };

            // Load transactions when month/year changes
            useEffect(() => {
                const monthTransactions = window.CloudSync.getUserData(currentUser, selectedYear, selectedMonth);
                setTransactions(monthTransactions);
                
                // Update the form date to match the selected month/year
                setFormData(prev => ({
                    ...prev,
                    date: getDefaultDateForMonth(selectedYear, selectedMonth)
                }));
            }, [currentUser, selectedYear, selectedMonth]);

            // Save data whenever transactions change
            useEffect(() => {
                window.CloudSync.saveUserData(currentUser, selectedYear, selectedMonth, transactions);
            }, [transactions, currentUser, selectedYear, selectedMonth]);

            const incomeCategories = [
                'Salary/Wages', 'Freelance', 'Business Income', 'Investment Returns', 
                'Rental Income', 'Side Hustle', 'Gifts/Bonus', 'Other Income'
            ];

            const expenseCategories = [
                'Housing', 'Transportation', 'Food & Dining', 'Utilities', 'Healthcare',
                'Insurance', 'Shopping', 'Entertainment', 'Education', 'Personal Care',
                'Travel', 'Subscriptions', 'Debt Payments', 'Savings', 'Taxes', 'Other Expenses'
            ];

            const categoryIcons = {
                'Salary/Wages': '💼', 'Freelance': '💻', 'Business Income': '🏢', 'Investment Returns': '📈',
                'Rental Income': '🏠', 'Side Hustle': '🚀', 'Gifts/Bonus': '🎁', 'Other Income': '💰',
                'Housing': '🏠', 'Transportation': '🚗', 'Food & Dining': '🍽️', 'Utilities': '⚡',
                'Healthcare': '🏥', 'Insurance': '🛡️', 'Shopping': '🛍️', 'Entertainment': '🎬',
                'Education': '📚', 'Personal Care': '💅', 'Travel': '✈️', 'Subscriptions': '📱',
                'Debt Payments': '💳', 'Savings': '🐷', 'Taxes': '📋', 'Other Expenses': '📦'
            };

            const monthEmojis = {
                'January': '❄️', 'February': '💝', 'March': '🌸', 'April': '🌱',
                'May': '🌷', 'June': '☀️', 'July': '🏖️', 'August': '🌻',
                'September': '🍂', 'October': '🎃', 'November': '🦃', 'December': '🎄'
            };

            const handleSubmit = () => {
                if (!formData.category || !formData.amount) return;

                const newTransaction = {
                    id: Date.now(),
                    ...formData,
                    amount: parseFloat(formData.amount),
                    date: formData.date
                };

                setTransactions([newTransaction, ...transactions]);
                setFormData({
                    type: 'expense',
                    category: '',
                    amount: '',
                    description: '',
                    date: getDefaultDateForMonth(selectedYear, selectedMonth)
                });
                setShowMobileForm(false);
            };

            const deleteTransaction = (id) => {
                setTransactions(transactions.filter(t => t.id !== id));
            };

            const totalIncome = transactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);

            const totalExpenses = transactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);

            const balance = totalIncome - totalExpenses;

            const getCategoryTotals = (type) => {
                const categories = type === 'income' ? incomeCategories : expenseCategories;
                return categories.map(category => {
                    const categoryTransactions = transactions.filter(t => t.type === type && t.category === category);
                    const total = categoryTransactions.reduce((sum, t) => sum + t.amount, 0);
                    return { category, total, count: categoryTransactions.length };
                }).filter(c => c.total > 0);
            };

            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: 'INR'
                }).format(amount);
            };

            const handleAddUser = () => {
                setUserRefresh(prev => prev + 1);
            };

            const handlePasswordChanged = () => {
                console.log('Password changed successfully');
            };

            const changeMonth = (direction) => {
                const currentIndex = monthNames.indexOf(selectedMonth);
                let newIndex, newYear = selectedYear;
                
                if (direction === 'prev') {
                    newIndex = currentIndex - 1;
                    if (newIndex < 0) {
                        newIndex = 11;
                        newYear = selectedYear - 1;
                        if (newYear < 2025) {
                            newYear = 2025;
                            newIndex = 0;
                        }
                    }
                } else {
                    newIndex = currentIndex + 1;
                    if (newIndex > 11) {
                        newIndex = 0;
                        newYear = selectedYear + 1;
                        if (newYear > 2030) {
                            newYear = 2030;
                            newIndex = 11;
                        }
                    }
                }
                
                setSelectedMonth(monthNames[newIndex]);
                setSelectedYear(newYear);
            };

            const getMonthSummary = (monthName) => {
                const monthData = window.CloudSync.getUserData(currentUser, selectedYear, monthName);
                const income = monthData.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expenses = monthData.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                return { income, expenses, balance: income - expenses, transactions: monthData.length };
            };

            // FIXED: Improved year summary calculation
            const getYearSummary = () => {
                let totalIncome = 0;
                let totalExpenses = 0;
                let totalTransactions = 0;
                let monthsWithData = 0;
                const monthlyBreakdown = [];
                
                monthNames.forEach(month => {
                    const monthData = window.CloudSync.getUserData(currentUser, selectedYear, month);
                    const monthIncome = monthData.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                    const monthExpenses = monthData.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                    
                    totalIncome += monthIncome;
                    totalExpenses += monthExpenses;
                    totalTransactions += monthData.length;
                    
                    if (monthData.length > 0) {
                        monthsWithData++;
                    }
                    
                    monthlyBreakdown.push({
                        month,
                        income: monthIncome,
                        expenses: monthExpenses,
                        balance: monthIncome - monthExpenses,
                        transactions: monthData.length
                    });
                });
                
                return {
                    totalIncome,
                    totalExpenses,
                    yearBalance: totalIncome - totalExpenses,
                    totalTransactions,
                    monthsWithData,
                    monthlyBreakdown,
                    averageMonthlyIncome: monthsWithData > 0 ? totalIncome / monthsWithData : 0,
                    averageMonthlyExpenses: monthsWithData > 0 ? totalExpenses / monthsWithData : 0
                };
            };

            const yearSummary = getYearSummary();

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
                    {/* Mobile Header */}
                    <div className="mobile-sticky-header bg-white px-4 py-3 sm:px-6">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="text-2xl">💰</div>
                                <div>
                                    <h1 className="text-lg font-bold text-gray-800">Monthly Tracker</h1>
                                    <p className="text-xs text-gray-600">Welcome, {userName}</p>
                                </div>
                            </div>
                            <button
                                onClick={() => setShowMobileMenu(true)}
                                className="p-2 hover:bg-gray-100 rounded-lg touch-target"
                            >
                                <Menu />
                            </button>
                        </div>
                    </div>

                    <div className="p-4 pb-24">
                        {/* Add User Modal */}
                        {showAddUser && (
                            <AddUserForm 
                                onAddUser={handleAddUser}
                                onClose={() => setShowAddUser(false)}
                            />
                        )}

                        {/* Change Password Modal */}
                        {showChangePassword && (
                            <ChangePasswordForm 
                                currentUser={currentUser}
                                onClose={() => setShowChangePassword(false)}
                                onPasswordChanged={handlePasswordChanged}
                            />
                        )}

                        {/* Admin Credentials Panel */}
                        {isAdmin && showCredentials && (
                            <div className="bg-white rounded-xl shadow-lg p-4 mb-6 border-l-4 border-blue-500">
                                <h3 className="text-lg font-semibold text-gray-800 mb-4">User Management (Admin View)</h3>
                                <div className="space-y-3">
                                    {Object.entries(window.CloudSync.users).map(([username, user]) => (
                                        <div key={username} className="bg-gray-50 p-3 rounded-lg">
                                            <p className="font-medium text-gray-800">{user.name}</p>
                                            <p className="text-sm text-gray-600">Username: <span className="font-mono">{username}</span></p>
                                            <p className="text-sm text-gray-600">Password: <span className="font-mono">{user.password}</span></p>
                                            {user.isAdmin && <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Admin</span>}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Month Navigation */}
                        <div className="bg-white rounded-xl shadow-lg p-4 mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <button
                                    onClick={() => changeMonth('prev')}
                                    className="flex items-center gap-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors touch-target"
                                >
                                    <ChevronLeft />
                                    <span className="text-sm">Prev</span>
                                </button>
                                
                                <div className="text-center">
                                    <div className="text-xl font-bold text-gray-800 flex items-center gap-2 justify-center mb-2">
                                        <span>{monthEmojis[selectedMonth]}</span>
                                        <span>{selectedMonth} {selectedYear}</span>
                                    </div>
                                    
                                    <div className="flex items-center justify-center gap-2">
                                        <label className="text-xs font-medium text-gray-600">Year:</label>
                                        <select
                                            value={selectedYear}
                                            onChange={(e) => setSelectedYear(parseInt(e.target.value))}
                                            className="px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white"
                                        >
                                            {[2025, 2026, 2027, 2028, 2029, 2030].map(year => (
                                                <option key={year} value={year}>{year}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                                
                                <button
                                    onClick={() => changeMonth('next')}
                                    className="flex items-center gap-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors touch-target"
                                >
                                    <span className="text-sm">Next</span>
                                    <ChevronRight />
                                </button>
                            </div>

                            {/* Scrollable Month Grid */}
                            <div className="mb-4">
                                <div className="text-center text-xs text-gray-600 mb-3">
                                    <span className="bg-gray-100 px-2 py-1 rounded-full">
                                        📅 {selectedYear} - Tap any month to switch
                                    </span>
                                </div>
                                <div className="grid grid-cols-3 sm:grid-cols-4 gap-2">
                                    {monthNames.map((month) => {
                                        const summary = getMonthSummary(month);
                                        const isSelected = month === selectedMonth;
                                        const hasData = summary.transactions > 0;
                                        
                                        return (
                                            <button
                                                key={month}
                                                onClick={() => setSelectedMonth(month)}
                                                className={`month-tab p-3 rounded-lg text-center transition-all touch-feedback ${
                                                    isSelected 
                                                        ? 'bg-blue-500 text-white shadow-lg' 
                                                        : hasData 
                                                            ? 'bg-green-100 hover:bg-green-200 text-green-800'
                                                            : 'bg-gray-100 hover:bg-gray-200 text-gray-600'
                                                }`}
                                            >
                                                <div className="text-lg mb-1">{monthEmojis[month]}</div>
                                                <div className="text-xs font-medium">{month.slice(0, 3)}</div>
                                                {hasData && (
                                                    <div className="text-xs mt-1">
                                                        <div>{summary.transactions}</div>
                                                        <div className={summary.balance >= 0 ? 'text-green-600' : 'text-red-600'}>
                                                            {isSelected ? (summary.balance >= 0 ? '+' : '') + formatCurrency(summary.balance).slice(1, 6) + '...' : '●'}
                                                        </div>
                                                    </div>
                                                )}
                                            </button>
                                        );
                                    })}
                                </div>
                            </div>

                            {/* FIXED: Enhanced Year Summary */}
                            <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-3">
                                <div className="flex items-center justify-between mb-2">
                                    <h4 className="text-sm font-semibold text-gray-700">📊 {selectedYear} Year Summary</h4>
                                    <button
                                        onClick={() => setShowYearSummaryExpanded(!showYearSummaryExpanded)}
                                        className="p-1 hover:bg-white/50 rounded transition-colors touch-target"
                                    >
                                        {showYearSummaryExpanded ? <ChevronUp /> : <ChevronDown />}
                                    </button>
                                </div>
                                
                                <div className="grid grid-cols-3 gap-2 text-center text-xs mb-2">
                                    <div>
                                        <div className="font-bold text-green-600">
                                            ₹{yearSummary.totalIncome > 99999 
                                                ? (yearSummary.totalIncome / 100000).toFixed(1) + 'L'
                                                : (yearSummary.totalIncome / 1000).toFixed(0) + 'K'
                                            }
                                        </div>
                                        <div className="text-gray-600">Income</div>
                                    </div>
                                    <div>
                                        <div className="font-bold text-red-600">
                                            ₹{yearSummary.totalExpenses > 99999 
                                                ? (yearSummary.totalExpenses / 100000).toFixed(1) + 'L'
                                                : (yearSummary.totalExpenses / 1000).toFixed(0) + 'K'
                                            }
                                        </div>
                                        <div className="text-gray-600">Expenses</div>
                                    </div>
                                    <div>
                                        <div className={`font-bold ${yearSummary.yearBalance >= 0 ? 'text-blue-600' : 'text-red-600'}`}>
                                            ₹{Math.abs(yearSummary.yearBalance) > 99999 
                                                ? (yearSummary.yearBalance / 100000).toFixed(1) + 'L'
                                                : (yearSummary.yearBalance / 1000).toFixed(0) + 'K'
                                            }
                                        </div>
                                        <div className="text-gray-600">Balance</div>
                                    </div>
                                </div>

                                <div className="flex justify-between text-xs text-gray-600">
                                    <span>{yearSummary.totalTransactions} transactions</span>
                                    <span>{yearSummary.monthsWithData}/12 months active</span>
                                </div>

                                {/* Expanded Year Summary */}
                                {showYearSummaryExpanded && (
                                    <div className="year-summary-expanded mt-4 pt-4 border-t border-gray-200">
                                        <div className="grid grid-cols-2 gap-4 text-xs mb-4">
                                            <div className="bg-white/70 p-2 rounded">
                                                <div className="font-semibold text-gray-700">Monthly Averages</div>
                                                <div className="text-green-600">Income: ₹{(yearSummary.averageMonthlyIncome / 1000).toFixed(0)}K</div>
                                                <div className="text-red-600">Expenses: ₹{(yearSummary.averageMonthlyExpenses / 1000).toFixed(0)}K</div>
                                            </div>
                                            <div className="bg-white/70 p-2 rounded">
                                                <div className="font-semibold text-gray-700">Savings Rate</div>
                                                <div className={`font-bold ${yearSummary.yearBalance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                    {yearSummary.totalIncome > 0 
                                                        ? ((yearSummary.yearBalance / yearSummary.totalIncome) * 100).toFixed(1) + '%'
                                                        : '0%'
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="space-y-1">
                                            {yearSummary.monthlyBreakdown.map((monthData, index) => {
                                                if (monthData.transactions === 0) return null;
                                                
                                                return (
                                                    <div key={monthData.month} className="flex items-center justify-between bg-white/50 p-2 rounded text-xs">
                                                        <div className="flex items-center gap-2">
                                                            <span>{monthEmojis[monthData.month]}</span>
                                                            <span className="font-medium">{monthData.month.slice(0, 3)}</span>
                                                        </div>
                                                        <div className="flex items-center gap-3">
                                                            <span className="text-green-600">+₹{(monthData.income / 1000).toFixed(0)}K</span>
                                                            <span className="text-red-600">-₹{(monthData.expenses / 1000).toFixed(0)}K</span>
                                                            <span className={`font-bold ${monthData.balance >= 0 ? 'text-blue-600' : 'text-red-600'}`}>
                                                                {monthData.balance >= 0 ? '+' : ''}₹{(monthData.balance / 1000).toFixed(0)}K
                                                            </span>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                        
                                        {yearSummary.monthsWithData === 0 && (
                                            <div className="text-center py-4 text-gray-500">
                                                <div className="text-2xl mb-2">📊</div>
                                                <p className="text-xs">No data for {selectedYear} yet</p>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Summary Cards */}
                        <div className="grid grid-cols-2 gap-4 mb-6">
                            <div className="bg-white rounded-xl shadow-lg p-4 border-l-4 border-green-500">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-xs text-gray-600 mb-1">Income</p>
                                        <p className="text-lg font-bold text-green-600">
                                            {totalIncome > 99999 ? `₹${(totalIncome/1000).toFixed(0)}K` : formatCurrency(totalIncome)}
                                        </p>
                                    </div>
                                    <div className="text-green-500">
                                        <TrendingUp />
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white rounded-xl shadow-lg p-4 border-l-4 border-red-500">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-xs text-gray-600 mb-1">Expenses</p>
                                        <p className="text-lg font-bold text-red-600">
                                            {totalExpenses > 99999 ? `₹${(totalExpenses/1000).toFixed(0)}K` : formatCurrency(totalExpenses)}
                                        </p>
                                    </div>
                                    <div className="text-red-500">
                                        <TrendingDown />
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white rounded-xl shadow-lg p-4 border-l-4 border-blue-500">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-xs text-gray-600 mb-1">Balance</p>
                                        <div className="flex items-center gap-2">
                                            <p className={`text-lg font-bold ${balance >= 0 ? 'text-blue-600' : 'text-red-600'}`}>
                                                {showBalance ? 
                                                    (Math.abs(balance) > 99999 ? `₹${(balance/1000).toFixed(0)}K` : formatCurrency(balance))
                                                    : '****'
                                                }
                                            </p>
                                            <button
                                                onClick={() => setShowBalance(!showBalance)}
                                                className="text-gray-400 hover:text-gray-600 touch-target"
                                            >
                                                {showBalance ? <EyeOff /> : <Eye />}
                                            </button>
                                        </div>
                                    </div>
                                    <div className="text-blue-500">
                                        <RupeeSign />
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white rounded-xl shadow-lg p-4 border-l-4 border-purple-500">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="text-xs text-gray-600 mb-1">Transactions</p>
                                        <p className="text-lg font-bold text-purple-600">{transactions.length}</p>
                                    </div>
                                    <div className="text-purple-500 text-2xl">📊</div>
                                </div>
                            </div>
                        </div>

                        {/* Charts Section - Mobile Optimized */}
                        <div className="space-y-6 mb-6">
                            <div className="bg-white rounded-xl shadow-lg p-4">
                                <h3 className="text-base font-semibold text-gray-800 mb-4 text-center">
                                    Income Distribution - {selectedMonth}
                                </h3>
                                <PieChart 
                                    data={getCategoryTotals('income')} 
                                    title="Income Distribution"
                                    type="income"
                                />
                            </div>

                            <div className="bg-white rounded-xl shadow-lg p-4">
                                <h3 className="text-base font-semibold text-gray-800 mb-4 text-center">
                                    Expense Distribution - {selectedMonth}
                                </h3>
                                <PieChart 
                                    data={getCategoryTotals('expense')} 
                                    title="Expense Distribution"
                                    type="expense"
                                />
                            </div>
                        </div>

                        {/* Transaction History */}
                        <div className="bg-white rounded-xl shadow-lg p-4">
                            <h3 className="text-base font-semibold text-gray-800 mb-4">
                                {selectedMonth} {selectedYear} Transactions
                            </h3>
                            
                            {transactions.length === 0 ? (
                                <div className="text-center py-12 text-gray-500">
                                    <div className="text-4xl mb-2">{monthEmojis[selectedMonth]}</div>
                                    <p className="text-sm">No transactions for {selectedMonth} yet.</p>
                                    <p className="text-xs mt-2">Tap the + button to add your first transaction!</p>
                                </div>
                            ) : (
                                <div className="space-y-3 mobile-scroll">
                                    {transactions.map(transaction => (
                                        <div
                                            key={transaction.id}
                                            className={`flex items-center justify-between p-3 rounded-lg border-l-4 ${
                                                transaction.type === 'income' 
                                                    ? 'bg-green-50 border-green-500' 
                                                    : 'bg-red-50 border-red-500'
                                            }`}
                                        >
                                            <div className="flex items-center gap-3 flex-1 min-w-0">
                                                <div className="text-xl">
                                                    {categoryIcons[transaction.category]}
                                                </div>
                                                <div className="min-w-0 flex-1">
                                                    <p className="font-medium text-gray-800 text-sm truncate">{transaction.category}</p>
                                                    {transaction.description && (
                                                        <p className="text-xs text-gray-600 truncate">{transaction.description}</p>
                                                    )}
                                                    <p className="text-xs text-gray-500">{transaction.date}</p>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-2 ml-2">
                                                <span className={`font-bold text-sm ${
                                                    transaction.type === 'income' ? 'text-green-600' : 'text-red-600'
                                                }`}>
                                                    {transaction.type === 'income' ? '+' : '-'}
                                                    {transaction.amount > 99999 ? `₹${(transaction.amount/1000).toFixed(0)}K` : `₹${transaction.amount.toLocaleString('en-IN')}`}
                                                </span>
                                                <button
                                                    onClick={() => deleteTransaction(transaction.id)}
                                                    className="text-red-400 hover:text-red-600 p-1 touch-target"
                                                >
                                                    <Trash2 />
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Mobile FAB */}
                    <button
                        onClick={() => setShowMobileForm(true)}
                        className="mobile-fab w-14 h-14 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-full hover:from-blue-600 hover:to-purple-700 transition-all duration-200 touch-feedback"
                    >
                        <Plus />
                    </button>

                    {/* Mobile Menu Sheet */}
                    <MobileBottomSheet
                        isOpen={showMobileMenu}
                        onClose={() => setShowMobileMenu(false)}
                        title="Menu"
                    >
                        <div className="space-y-4">
                            <button
                                onClick={() => {
                                    setShowMobileMenu(false);
                                    setShowChangePassword(true);
                                }}
                                className="w-full flex items-center gap-3 p-3 text-left hover:bg-gray-50 rounded-lg touch-target"
                            >
                                <Lock />
                                <span>Change Password</span>
                            </button>
                            
                            {isAdmin && (
                                <>
                                    <button
                                        onClick={() => {
                                            setShowMobileMenu(false);
                                            setShowAddUser(true);
                                        }}
                                        className="w-full flex items-center gap-3 p-3 text-left hover:bg-gray-50 rounded-lg touch-target"
                                    >
                                        <UserPlus />
                                        <span>Add User</span>
                                    </button>
                                    <button
                                        onClick={() => {
                                            setShowCredentials(!showCredentials);
                                            setShowMobileMenu(false);
                                        }}
                                        className="w-full flex items-center gap-3 p-3 text-left hover:bg-gray-50 rounded-lg touch-target"
                                    >
                                        <Eye />
                                        <span>{showCredentials ? 'Hide' : 'Show'} Users</span>
                                    </button>
                                </>
                            )}
                            
                            <button
                                onClick={() => {
                                    setShowMobileMenu(false);
                                    onLogout();
                                }}
                                className="w-full flex items-center gap-3 p-3 text-left hover:bg-gray-50 rounded-lg text-red-600 touch-target"
                            >
                                <LogOut />
                                <span>Logout</span>
                            </button>
                        </div>
                    </MobileBottomSheet>

                    {/* Mobile Form Sheet */}
                    <MobileBottomSheet
                        isOpen={showMobileForm}
                        onClose={() => setShowMobileForm(false)}
                        title={`Add Transaction to ${selectedMonth}`}
                    >
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Type</label>
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => setFormData({...formData, type: 'income', category: ''})}
                                        className={`flex-1 py-3 px-4 rounded-lg font-medium transition-all touch-feedback ${
                                            formData.type === 'income'
                                                ? 'bg-green-500 text-white'
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                        }`}
                                    >
                                        Income
                                    </button>
                                    <button
                                        onClick={() => setFormData({...formData, type: 'expense', category: ''})}
                                        className={`flex-1 py-3 px-4 rounded-lg font-medium transition-all touch-feedback ${
                                            formData.type === 'expense'
                                                ? 'bg-red-500 text-white'
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                        }`}
                                    >
                                        Expense
                                    </button>
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                <select
                                    value={formData.category}
                                    onChange={(e) => setFormData({...formData, category: e.target.value})}
                                    className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                >
                                    <option value="">Select category</option>
                                    {(formData.type === 'income' ? incomeCategories : expenseCategories).map(cat => (
                                        <option key={cat} value={cat}>{categoryIcons[cat]} {cat}</option>
                                    ))}
                                </select>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Amount (₹)</label>
                                <input
                                    type="number"
                                    step="0.01"
                                    value={formData.amount}
                                    onChange={(e) => setFormData({...formData, amount: e.target.value})}
                                    className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="0.00"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                <input
                                    type="text"
                                    value={formData.description}
                                    onChange={(e) => setFormData({...formData, description: e.target.value})}
                                    className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Optional description"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Date</label>
                                <input
                                    type="date"
                                    value={formData.date}
                                    onChange={(e) => setFormData({...formData, date: e.target.value})}
                                    className="w-full p-4 text-base border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                />
                            </div>

                            <button
                                onClick={handleSubmit}
                                disabled={!formData.category || !formData.amount}
                                className="w-full bg-gradient-to-r from-green-500 to-blue-600 text-white py-4 px-4 rounded-lg hover:from-green-600 hover:to-blue-700 transition-all duration-200 font-semibold touch-feedback disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                Add to {selectedMonth} {selectedYear}
                            </button>
                        </div>
                    </MobileBottomSheet>
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [userName, setUserName] = useState('');
            const [isAdmin, setIsAdmin] = useState(false);

            // Check if user is already logged in
            useEffect(() => {
                const savedUser = localStorage.getItem('currentUser');
                const savedUserName = localStorage.getItem('currentUserName');
                const savedIsAdmin = localStorage.getItem('currentIsAdmin') === 'true';
                if (savedUser && savedUserName) {
                    setCurrentUser(savedUser);
                    setUserName(savedUserName);
                    setIsAdmin(savedIsAdmin);
                }
            }, []);

            const handleLogin = (username, name, adminStatus) => {
                setCurrentUser(username);
                setUserName(name);
                setIsAdmin(adminStatus);
                localStorage.setItem('currentUser', username);
                localStorage.setItem('currentUserName', name);
                localStorage.setItem('currentIsAdmin', adminStatus.toString());
            };

            const handleLogout = () => {
                setCurrentUser(null);
                setUserName('');
                setIsAdmin(false);
                localStorage.removeItem('currentUser');
                localStorage.removeItem('currentUserName');
                localStorage.removeItem('currentIsAdmin');
            };

            if (!currentUser) {
                return <LoginForm onLogin={handleLogin} />;
            }

            return (
                <MonthlyTracker 
                    currentUser={currentUser} 
                    userName={userName} 
                    isAdmin={isAdmin}
                    onLogout={handleLogout} 
                />
            );
        };

        // Hide loading screen and render app
        setTimeout(() => {
            document.body.classList.add('app-loaded');
            ReactDOM.render(<App />, document.getElementById('root'));
        }, 1500);

        // Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'monthly-tracker-v6';
                    const urlsToCache = ['/'];
                    
                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => cache.addAll(urlsToCache))
                        );
                    });
                    
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => response || fetch(event.request))
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(registration => console.log('SW registered'))
                    .catch(error => console.log('SW registration failed'));
            });
        }

        // Add touch event handling for better mobile experience
        document.addEventListener('touchstart', function(){}, {passive: true});
        
        // Prevent double-tap zoom
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            var now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>
